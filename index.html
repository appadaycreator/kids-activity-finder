<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>子供の習い事診断 - お子様にぴったりの習い事を見つけよう</title>
    <meta name="description" content="性格と興味から最適な習い事を診断。プログラミング、英会話、スポーツ、音楽など100種類以上から幅広くサポート">
    
    <!-- OGP Meta Tags -->
    <meta property="og:title" content="子供の習い事診断 - お子様にぴったりの習い事を見つけよう">
    <meta property="og:description" content="性格と興味から最適な習い事を診断。プログラミング、英会話、スポーツ、音楽など100種類以上から幅広くサポート">
    <meta property="og:image" content="https://cdn1.genspark.ai/user-upload-image/22_generated/1b2b567c-0e98-49ba-9ed5-13daec7598d5">
    <meta property="og:url" content="https://appadaycreator.github.io/kids-activity-finder/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- PWA Meta -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi5a2Q5L6b44Gu57+S44GE5LqL6Kit5pat44CCIiwic2hvcnRfbmFtZSI6Iue/kuOBhOS6i+ioo+aWrSIsImRlc2NyaXB0aW9uIjoi44GK5a2Q5qeY44Gr44G044Gj44Gf44KK44Gu57+S44GE5LqL44KS6KaL44Gk44GR44KI44GGIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmOGZhZmMiLCJ0aGVtZV9jb2xvciI6IiM2MzY2ZjEifQ==">
    <meta name="theme-color" content="#6366f1">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzYzNjZmMSIvPgo8cGF0aCBkPSJNOSAxMmg2djJIOXYtMnptMCA0aDEwdjJIOXYtMnptMCA0aDh2Mkg5di0yeiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+">
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TXQGZRF9');</script>
    <!-- End Google Tag Manager -->
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .result-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .result-card:nth-child(2) {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .result-card:nth-child(3) {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TXQGZRF9"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <!-- Header -->
    <header class="gradient-bg text-white py-6">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl font-bold text-center">
                <i class="fas fa-child mr-2"></i>
                子供の習い事診断
            </h1>
            <p class="text-center mt-2 text-lg opacity-90">お子様にぴったりの習い事を見つけよう（100種類以上対応）</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="max-w-2xl mx-auto animate-fade-in">
            <div class="bg-white rounded-xl card-shadow p-8 text-center">
                <img src="https://cdn1.genspark.ai/user-upload-image/22_generated/1b2b567c-0e98-49ba-9ed5-13daec7598d5" 
                     alt="子供の習い事のイメージ" class="w-full max-w-md mx-auto rounded-lg mb-6">
                
                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-star text-yellow-500 mr-2"></i>
                    お子様の可能性を発見しよう！
                </h2>
                <p class="text-gray-600 mb-6 text-lg">
                    性格分析と適性診断で、100種類以上の習い事からお子様にぴったりのものをご提案します。<br>
                    科学的なアプローチで、お子様の隠れた才能を見つけてみませんか？
                </p>
                
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div class="text-center">
                        <i class="fas fa-bullseye text-4xl text-blue-500 mb-3"></i>
                        <h3 class="font-bold text-lg">100種類から適性マッチング</h3>
                        <p class="text-gray-600">豊富な選択肢から最適な習い事を提案</p>
                    </div>
                    <div class="text-center">
                        <i class="fas fa-chart-bar text-4xl text-green-500 mb-3"></i>
                        <h3 class="font-bold text-lg">詳細レポート</h3>
                        <p class="text-gray-600">具体的な理由と教室情報をお届け</p>
                    </div>
                </div>
                
                <p class="text-sm text-gray-500 mb-6">
                    <i class="fas fa-clock mr-1"></i>所要時間：約3分 | 
                    <i class="fas fa-save mr-1"></i>診断結果は保存されます
                </p>
                
                <button id="start-btn" class="btn-primary text-white py-4 px-8 rounded-full text-xl font-bold w-full">
                    <i class="fas fa-play mr-2"></i>診断をスタート
                </button>
            </div>
        </div>

        <!-- Progress Bar -->
        <div id="progress-container" class="max-w-2xl mx-auto mb-6 hidden">
            <div class="bg-white rounded-xl card-shadow p-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">進捗状況</span>
                    <span id="progress-text" class="text-sm font-medium text-blue-600">1/6</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progress-bar" class="progress-bar bg-blue-600 h-3 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Question Screen -->
        <div id="question-screen" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-xl card-shadow p-8">
                <h2 id="question-title" class="text-2xl font-bold text-gray-800 mb-6 text-center"></h2>
                <div id="question-content" class="space-y-4"></div>
                <div class="flex justify-between mt-8">
                    <button id="prev-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-lg font-medium hidden">
                        <i class="fas fa-arrow-left mr-2"></i>前に戻る
                    </button>
                    <button id="next-btn" class="btn-primary text-white py-3 px-6 rounded-lg font-medium ml-auto" disabled>
                        次へ進む<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-xl card-shadow p-8 text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">診断結果を計算中...</h3>
                <p class="text-gray-600">100種類以上の習い事からお子様の適性を分析しています</p>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="max-w-4xl mx-auto hidden">
            <div class="bg-white rounded-xl card-shadow p-8">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">
                    <i class="fas fa-trophy text-yellow-500 mr-2"></i>
                    診断結果
                </h2>
                
                <!-- Personality Analysis -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-user-check mr-2"></i>性格分析結果
                    </h3>
                    <div id="personality-result" class="bg-blue-50 rounded-lg p-4"></div>
                </div>

                <!-- Chart -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-radar mr-2"></i>適性チャート（カテゴリ別）
                    </h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <canvas id="aptitude-chart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Top 10 Recommendations -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-medal mr-2"></i>おすすめ習い事 TOP10
                    </h3>
                    <div id="recommendations" class="grid md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>

                <!-- Action Buttons -->
                <div class="text-center space-y-4">
                    <div class="flex flex-wrap justify-center gap-4">
                        <button id="share-btn" class="bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-medium">
                            <i class="fab fa-twitter mr-2"></i>結果をシェア
                        </button>
                        <button id="save-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-medium">
                            <i class="fas fa-save mr-2"></i>結果を保存
                        </button>
                        <button id="compare-btn" class="bg-purple-500 hover:bg-purple-600 text-white py-3 px-6 rounded-lg font-medium">
                            <i class="fas fa-users mr-2"></i>友達と比較
                        </button>
                        <button id="retry-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-lg font-medium">
                            <i class="fas fa-redo mr-2"></i>もう一度診断
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Screen -->
        <div id="history-screen" class="max-w-4xl mx-auto hidden">
            <div class="bg-white rounded-xl card-shadow p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-history mr-2"></i>診断履歴
                </h2>
                <div id="history-content"></div>
                <button id="back-to-result-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-medium mt-6">
                    <i class="fas fa-arrow-left mr-2"></i>結果に戻る
                </button>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-100 py-8 mt-12">
        <div class="container mx-auto px-4">
            <div class="flex flex-wrap justify-center space-x-6 text-sm text-gray-600">
                <a href="privacy-policy.html" class="hover:text-blue-600">プライバシーポリシー</a>
                <a href="disclaimer.html" class="hover:text-blue-600">免責事項</a>
                <a href="contact.html" class="hover:text-blue-600">お問い合わせ</a>
            </div>
            <div class="text-center mt-4 text-sm text-gray-500">
                &copy; 2024 Kids Activity Finder. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        // Debug function
        function debugLog(message) {
            console.log('[習い事診断] ' + message);
        }

        // Application state
        var appState = {
            currentQuestion: 0,
            answers: {},
            result: null,
            startTime: null
        };

        // Questions data
        var questions = [
            {
                id: 'age',
                title: 'お子様の年齢を教えてください',
                type: 'radio',
                options: [
                    { value: '3-4', label: '3-4歳（幼稚園年少）' },
                    { value: '5-6', label: '5-6歳（幼稚園年中・年長）' },
                    { value: '7-9', label: '7-9歳（小学校低学年）' },
                    { value: '10-12', label: '10-12歳（小学校高学年）' },
                    { value: '13-15', label: '13-15歳（中学生）' },
                    { value: '16-18', label: '16-18歳（高校生）' }
                ]
            },
            {
                id: 'personality',
                title: 'お子様の性格に最も近いものは？',
                type: 'radio',
                options: [
                    { value: 'active', label: '活発で体を動かすのが好き' },
                    { value: 'creative', label: '創造的で芸術的なことが好き' },
                    { value: 'logical', label: '論理的で考えることが好き' },
                    { value: 'social', label: '社交的で人と話すのが好き' },
                    { value: 'quiet', label: '静かで集中して取り組むのが好き' }
                ]
            },
            {
                id: 'interests',
                title: 'お子様が最も興味を示すのは？',
                type: 'radio',
                options: [
                    { value: 'sports', label: 'スポーツ・運動' },
                    { value: 'art', label: '絵画・工作・音楽' },
                    { value: 'science', label: '実験・プログラミング・数学' },
                    { value: 'language', label: '読書・言語・コミュニケーション' },
                    { value: 'performance', label: '演技・ダンス・発表' }
                ]
            },
            {
                id: 'energy',
                title: 'お子様の体力レベルは？',
                type: 'radio',
                options: [
                    { value: 'high', label: 'とても高い（常に元気いっぱい）' },
                    { value: 'medium-high', label: '高い（活発に動き回る）' },
                    { value: 'medium', label: '普通（適度に活動する）' },
                    { value: 'medium-low', label: 'やや低い（ゆったりと過ごす）' },
                    { value: 'low', label: '低い（静かな活動を好む）' }
                ]
            },
            {
                id: 'budget',
                title: '月額予算はどれくらいですか？',
                type: 'radio',
                options: [
                    { value: 'low', label: '〜5,000円' },
                    { value: 'medium-low', label: '5,000円〜10,000円' },
                    { value: 'medium', label: '10,000円〜15,000円' },
                    { value: 'medium-high', label: '15,000円〜20,000円' },
                    { value: 'high', label: '20,000円以上' }
                ]
            },
            {
                id: 'transportation',
                title: '送迎について教えてください',
                type: 'radio',
                options: [
                    { value: 'easy', label: '平日・休日ともに送迎可能' },
                    { value: 'weekend', label: '休日のみ送迎可能' },
                    { value: 'near', label: '近所の教室なら送迎可能' },
                    { value: 'online', label: 'オンラインレッスン希望' },
                    { value: 'difficult', label: '送迎は困難' }
                ]
            }
        ];

        // Activities database with 100+ activities
        var activities = {
            // スポーツ・運動系 (30種類)
            soccer: {
                name: 'サッカー',
                description: 'チームワークと協調性を育むスポーツの王様',
                category: 'sports',
                icon: 'fas fa-futbol',
                benefits: ['チームワーク', '持久力向上', '協調性', '戦略的思考'],
                cost: '月額6,000円〜12,000円',
                ageRange: '3歳〜18歳',
                timeCommitment: '週2回 90分',
                traits: ['active', 'social']
            },
            swimming: {
                name: '水泳',
                description: '全身運動で健康的な体作りを目指す',
                category: 'sports',
                icon: 'fas fa-swimmer',
                benefits: ['全身運動', '持久力向上', '姿勢改善', '心肺機能向上'],
                cost: '月額8,000円〜15,000円',
                ageRange: '3歳〜18歳',
                timeCommitment: '週2回 60分',
                traits: ['active', 'quiet']
            },
            baseball: {
                name: '野球',
                description: '集中力と反射神経を鍛える人気スポーツ',
                category: 'sports',
                icon: 'fas fa-baseball-ball',
                benefits: ['反射神経', '集中力', 'チームワーク', '戦術理解'],
                cost: '月額5,000円〜10,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週2回 120分',
                traits: ['active', 'logical']
            },
            tennis: {
                name: 'テニス',
                description: '個人技術と戦略性を磨くスポーツ',
                category: 'sports',
                icon: 'fas fa-table-tennis',
                benefits: ['反射神経', '戦略的思考', '集中力', '持久力'],
                cost: '月額8,000円〜20,000円',
                ageRange: '5歳〜18歳',
                timeCommitment: '週1回 60分',
                traits: ['active', 'logical']
            },
            basketball: {
                name: 'バスケットボール',
                description: 'スピードと判断力を養うチームスポーツ',
                category: 'sports',
                icon: 'fas fa-basketball-ball',
                benefits: ['瞬発力', '判断力', 'チームワーク', '身長促進'],
                cost: '月額5,000円〜10,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週2回 90分',
                traits: ['active', 'social']
            },
            volleyball: {
                name: 'バレーボール',
                description: 'チームプレイと反射神経を鍛える',
                category: 'sports',
                icon: 'fas fa-volleyball-ball',
                benefits: ['反射神経', 'チームワーク', 'ジャンプ力', '協調性'],
                cost: '月額4,000円〜8,000円',
                ageRange: '10歳〜18歳',
                timeCommitment: '週2回 90分',
                traits: ['active', 'social']
            },
            gymnastics: {
                name: '体操',
                description: '柔軟性とバランス感覚を育む基礎運動',
                category: 'sports',
                icon: 'fas fa-running',
                benefits: ['柔軟性', 'バランス感覚', '筋力向上', '集中力'],
                cost: '月額6,000円〜15,000円',
                ageRange: '3歳〜18歳',
                timeCommitment: '週1回 60分',
                traits: ['active', 'quiet']
            },
            judo: {
                name: '柔道',
                description: '礼儀と精神力を鍛える日本の武道',
                category: 'martial_arts',
                icon: 'fas fa-fist-raised',
                benefits: ['礼儀作法', '精神力', '体幹強化', '護身術'],
                cost: '月額5,000円〜10,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週2回 90分',
                traits: ['active', 'quiet']
            },
            kendo: {
                name: '剣道',
                description: '日本古来の武道で心身を鍛える',
                category: 'martial_arts',
                icon: 'fas fa-sword',
                benefits: ['礼儀作法', '集中力', '精神力', '正しい姿勢'],
                cost: '月額4,000円〜8,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週2回 90分',
                traits: ['active', 'quiet']
            },
            karate: {
                name: '空手',
                description: '護身術と精神鍛錬を学ぶ武道',
                category: 'martial_arts',
                icon: 'fas fa-hand-rock',
                benefits: ['護身術', '精神力', '体力向上', '礼儀作法'],
                cost: '月額5,000円〜10,000円',
                ageRange: '4歳〜18歳',
                timeCommitment: '週2回 90分',
                traits: ['active', 'quiet']
            },
            track_field: {
                name: '陸上競技',
                description: '走る・跳ぶ・投げるの基本動作を鍛える',
                category: 'sports',
                icon: 'fas fa-running',
                benefits: ['基礎体力', '持久力', '瞬発力', '目標達成力'],
                cost: '月額3,000円〜8,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週2回 90分',
                traits: ['active', 'logical']
            },
            badminton: {
                name: 'バドミントン',
                description: '反射神経と戦略性を磨くラケットスポーツ',
                category: 'sports',
                icon: 'fas fa-shuttlecock',
                benefits: ['反射神経', '戦略的思考', '集中力', '持久力'],
                cost: '月額4,000円〜10,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['active', 'logical']
            },
            golf: {
                name: 'ゴルフ',
                description: '集中力と技術を磨く紳士のスポーツ',
                category: 'sports',
                icon: 'fas fa-golf-ball',
                benefits: ['集中力', '精密性', '忍耐力', '礼儀作法'],
                cost: '月額15,000円〜30,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 60分',
                traits: ['quiet', 'logical']
            },
            rugby: {
                name: 'ラグビー',
                description: 'フィジカルとメンタルを鍛える激しいスポーツ',
                category: 'sports',
                icon: 'fas fa-football-ball',
                benefits: ['フィジカル強化', 'チームワーク', '勇気', '戦略性'],
                cost: '月額5,000円〜10,000円',
                ageRange: '10歳〜18歳',
                timeCommitment: '週2回 120分',
                traits: ['active', 'social']
            },
            cycling: {
                name: 'サイクリング',
                description: '持久力と下半身を鍛える有酸素運動',
                category: 'sports',
                icon: 'fas fa-bicycle',
                benefits: ['持久力', '下半身強化', '心肺機能', '冒険心'],
                cost: '月額3,000円〜8,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['active', 'quiet']
            },

            // 音楽系 (25種類)
            piano: {
                name: 'ピアノ',
                description: '指先の器用さと音感を育む楽器の王様',
                category: 'music',
                icon: 'fas fa-piano',
                benefits: ['音感', '指先の器用さ', '集中力', '表現力'],
                cost: '月額8,000円〜20,000円',
                ageRange: '3歳〜18歳',
                timeCommitment: '週1回 30分',
                traits: ['creative', 'quiet']
            },
            violin: {
                name: 'バイオリン',
                description: '美しい音色で感情表現を学ぶ弦楽器',
                category: 'music',
                icon: 'fas fa-violin',
                benefits: ['音感', '姿勢改善', '集中力', '表現力'],
                cost: '月額10,000円〜25,000円',
                ageRange: '4歳〜18歳',
                timeCommitment: '週1回 30分',
                traits: ['creative', 'quiet']
            },
            guitar: {
                name: 'ギター',
                description: '幅広いジャンルで活躍する人気楽器',
                category: 'music',
                icon: 'fas fa-guitar',
                benefits: ['音感', '指先の器用さ', '創造力', '自己表現'],
                cost: '月額6,000円〜15,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['creative', 'social']
            },
            drums: {
                name: 'ドラム',
                description: 'リズム感と全身の協調性を鍛える',
                category: 'music',
                icon: 'fas fa-drum',
                benefits: ['リズム感', '協調性', 'ストレス発散', '集中力'],
                cost: '月額8,000円〜15,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['active', 'creative']
            },
            flute: {
                name: 'フルート',
                description: '美しい音色と正しい呼吸法を学ぶ',
                category: 'music',
                icon: 'fas fa-music',
                benefits: ['呼吸法', '音感', '集中力', '姿勢改善'],
                cost: '月額8,000円〜18,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 30分',
                traits: ['creative', 'quiet']
            },
            trumpet: {
                name: 'トランペット',
                description: '力強い音色で表現力を育む金管楽器',
                category: 'music',
                icon: 'fas fa-trumpet',
                benefits: ['肺活量', '音感', '表現力', '集中力'],
                cost: '月額8,000円〜18,000円',
                ageRange: '10歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['creative', 'social']
            },
            saxophone: {
                name: 'サックス',
                description: 'ジャズからクラシックまで幅広く活躍',
                category: 'music',
                icon: 'fas fa-saxophone',
                benefits: ['肺活量', '音感', '表現力', 'ジャズ感覚'],
                cost: '月額10,000円〜20,000円',
                ageRange: '12歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['creative', 'social']
            },
            cello: {
                name: 'チェロ',
                description: '深い音色で心の豊かさを育む大型弦楽器',
                category: 'music',
                icon: 'fas fa-cello',
                benefits: ['音感', '姿勢改善', '表現力', '集中力'],
                cost: '月額12,000円〜25,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['creative', 'quiet']
            },
            clarinet: {
                name: 'クラリネット',
                description: '柔らかな音色が魅力的な木管楽器',
                category: 'music',
                icon: 'fas fa-clarinet',
                benefits: ['呼吸法', '音感', '集中力', '表現力'],
                cost: '月額8,000円〜18,000円',
                ageRange: '10歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['creative', 'quiet']
            },
            trombone: {
                name: 'トロンボーン',
                description: 'スライドで音程を作る独特な金管楽器',
                category: 'music',
                icon: 'fas fa-trombone',
                benefits: ['肺活量', '音感', '協調性', '集中力'],
                cost: '月額8,000円〜18,000円',
                ageRange: '12歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['creative', 'logical']
            },
            voice_training: {
                name: '声楽・ボイストレーニング',
                description: '美しい歌声と正しい発声を学ぶ',
                category: 'music',
                icon: 'fas fa-microphone',
                benefits: ['発声法', '表現力', '自信向上', '肺活量'],
                cost: '月額6,000円〜15,000円',
                ageRange: '5歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['creative', 'social']
            },
            chorus: {
                name: '合唱',
                description: 'ハーモニーを通じて協調性を学ぶ',
                category: 'music',
                icon: 'fas fa-users-music',
                benefits: ['協調性', '音感', '表現力', 'チームワーク'],
                cost: '月額3,000円〜8,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['creative', 'social']
            },
            band: {
                name: '吹奏楽',
                description: '楽器演奏とアンサンブルを学ぶ',
                category: 'music',
                icon: 'fas fa-wind',
                benefits: ['協調性', '音感', 'チームワーク', '責任感'],
                cost: '月額5,000円〜12,000円',
                ageRange: '10歳〜18歳',
                timeCommitment: '週2回 120分',
                traits: ['creative', 'social']
            },
            ukulele: {
                name: 'ウクレレ',
                description: '気軽に始められる小さなギター',
                category: 'music',
                icon: 'fas fa-guitar',
                benefits: ['音感', '手軽さ', '創造力', 'リラックス'],
                cost: '月額4,000円〜10,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['creative', 'quiet']
            },
            harp: {
                name: 'ハープ',
                description: '天使の楽器と呼ばれる美しい弦楽器',
                category: 'music',
                icon: 'fas fa-harp',
                benefits: ['音感', '優雅さ', '集中力', '表現力'],
                cost: '月額15,000円〜30,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['creative', 'quiet']
            },

            // 学習・知育系 (15種類)
            programming: {
                name: 'プログラミング',
                description: '論理的思考力と創造力を育む現代的なスキル',
                category: 'study',
                icon: 'fas fa-code',
                benefits: ['論理的思考', '創造力', '問題解決力', '将来性'],
                cost: '月額8,000円〜15,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 60分',
                traits: ['logical', 'creative']
            },
            english: {
                name: '英会話',
                description: 'グローバル社会で活躍する語学力を身につける',
                category: 'study',
                icon: 'fas fa-globe',
                benefits: ['国際的コミュニケーション', '異文化理解', '将来性', '自信向上'],
                cost: '月額6,000円〜12,000円',
                ageRange: '3歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['social', 'logical']
            },
            abacus: {
                name: 'そろばん',
                description: '計算力と集中力を鍛える伝統的な学習法',
                category: 'study',
                icon: 'fas fa-calculator',
                benefits: ['計算力', '集中力', '記憶力', '右脳開発'],
                cost: '月額4,000円〜8,000円',
                ageRange: '5歳〜15歳',
                timeCommitment: '週2回 60分',
                traits: ['logical', 'quiet']
            },
            calligraphy: {
                name: '書道',
                description: '美しい文字と集中力を身につける日本の芸術',
                category: 'study',
                icon: 'fas fa-brush',
                benefits: ['集中力', '美的感覚', '姿勢改善', '文字の美しさ'],
                cost: '月額3,000円〜8,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 60分',
                traits: ['quiet', 'creative']
            },
            chinese: {
                name: '中国語',
                description: '将来性の高い中国語を楽しく学ぶ',
                category: 'study',
                icon: 'fas fa-language',
                benefits: ['語学力', '異文化理解', '将来性', '発音力'],
                cost: '月額6,000円〜12,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['social', 'logical']
            },
            french: {
                name: 'フランス語',
                description: '美しい響きのフランス語を学ぶ',
                category: 'study',
                icon: 'fas fa-language',
                benefits: ['語学力', '異文化理解', '美的感覚', '国際性'],
                cost: '月額6,000円〜12,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['social', 'creative']
            },
            korean: {
                name: '韓国語',
                description: '身近な韓国文化を通じて語学を学ぶ',
                category: 'study',
                icon: 'fas fa-language',
                benefits: ['語学力', '異文化理解', 'K-POP理解', '国際性'],
                cost: '月額5,000円〜10,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['social', 'creative']
            },
            robotics: {
                name: 'ロボット教室',
                description: 'ロボット製作を通じて理科と技術を学ぶ',
                category: 'study',
                icon: 'fas fa-robot',
                benefits: ['理科的思考', '創造力', '問題解決力', '手先の器用さ'],
                cost: '月額10,000円〜20,000円',
                ageRange: '6歳〜15歳',
                timeCommitment: '週1回 90分',
                traits: ['logical', 'creative']
            },
            mathematics: {
                name: '数学教室',
                description: '論理的思考力を鍛える数学の基礎学習',
                category: 'study',
                icon: 'fas fa-square-root-alt',
                benefits: ['論理的思考', '問題解決力', '集中力', '分析力'],
                cost: '月額6,000円〜15,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 60分',
                traits: ['logical', 'quiet']
            },
            science: {
                name: '科学実験教室',
                description: '実験を通じて科学の面白さを体験',
                category: 'study',
                icon: 'fas fa-flask',
                benefits: ['科学的思考', '観察力', '好奇心', '実験技術'],
                cost: '月額8,000円〜15,000円',
                ageRange: '6歳〜15歳',
                timeCommitment: '週1回 90分',
                traits: ['logical', 'creative']
            },
            reading: {
                name: '読書・国語教室',
                description: '読解力と表現力を高める国語学習',
                category: 'study',
                icon: 'fas fa-book',
                benefits: ['読解力', '表現力', '語彙力', '想像力'],
                cost: '月額5,000円〜10,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 60分',
                traits: ['quiet', 'creative']
            },

            // 芸術・創作系 (15種類)
            art_painting: {
                name: '絵画教室',
                description: '自由な発想で絵を描く創造性を育む',
                category: 'art',
                icon: 'fas fa-palette',
                benefits: ['創造力', '表現力', '集中力', '美的感覚'],
                cost: '月額5,000円〜12,000円',
                ageRange: '3歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['creative', 'quiet']
            },
            pottery: {
                name: '陶芸',
                description: '土と触れ合いながら作品を作る伝統工芸',
                category: 'art',
                icon: 'fas fa-vase',
                benefits: ['創造力', '集中力', '手先の器用さ', '忍耐力'],
                cost: '月額6,000円〜15,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 120分',
                traits: ['creative', 'quiet']
            },
            sculpture: {
                name: '彫刻',
                description: '立体造形を通じて空間認識力を育む',
                category: 'art',
                icon: 'fas fa-hammer',
                benefits: ['空間認識力', '創造力', '集中力', '手先の器用さ'],
                cost: '月額8,000円〜18,000円',
                ageRange: '10歳〜18歳',
                timeCommitment: '週1回 120分',
                traits: ['creative', 'logical']
            },
            photography: {
                name: '写真',
                description: '美しい瞬間を切り取る芸術的感性を育む',
                category: 'art',
                icon: 'fas fa-camera',
                benefits: ['美的感覚', '観察力', '創造力', 'デジタル技術'],
                cost: '月額8,000円〜20,000円',
                ageRange: '10歳〜18歳',
                timeCommitment: '週1回 120分',
                traits: ['creative', 'logical']
            },
            design: {
                name: 'デザイン',
                description: 'グラフィックデザインの基礎を学ぶ',
                category: 'art',
                icon: 'fas fa-pencil-ruler',
                benefits: ['デザイン力', '創造力', 'IT技術', '美的感覚'],
                cost: '月額10,000円〜20,000円',
                ageRange: '12歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['creative', 'logical']
            },
            handicraft: {
                name: '手芸・工作',
                description: '手先を使った創作活動で器用さを育む',
                category: 'art',
                icon: 'fas fa-cut',
                benefits: ['手先の器用さ', '創造力', '集中力', '完成の喜び'],
                cost: '月額3,000円〜8,000円',
                ageRange: '4歳〜15歳',
                timeCommitment: '週1回 90分',
                traits: ['creative', 'quiet']
            },
            origami: {
                name: '折り紙',
                description: '日本の伝統文化で集中力と手先の器用さを育む',
                category: 'art',
                icon: 'fas fa-paper-plane',
                benefits: ['手先の器用さ', '集中力', '空間認識力', '伝統文化'],
                cost: '月額2,000円〜5,000円',
                ageRange: '4歳〜15歳',
                timeCommitment: '週1回 60分',
                traits: ['quiet', 'logical']
            },
            manga: {
                name: '漫画・イラスト',
                description: 'ストーリーと絵で表現する現代的な芸術',
                category: 'art',
                icon: 'fas fa-pencil',
                benefits: ['表現力', '創造力', 'ストーリー構成', '集中力'],
                cost: '月額6,000円〜12,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['creative', 'quiet']
            },

            // ダンス・パフォーマンス系 (10種類)
            ballet: {
                name: 'バレエ',
                description: '優雅さと美しい姿勢を身につける古典舞踊',
                category: 'dance',
                icon: 'fas fa-shoe-prints',
                benefits: ['姿勢改善', '柔軟性', '表現力', '優雅さ'],
                cost: '月額8,000円〜20,000円',
                ageRange: '3歳〜18歳',
                timeCommitment: '週1回 60分',
                traits: ['creative', 'active']
            },
            jazz_dance: {
                name: 'ジャズダンス',
                description: 'リズミカルで表現豊かなモダンダンス',
                category: 'dance',
                icon: 'fas fa-music',
                benefits: ['リズム感', '表現力', '体力向上', '自信向上'],
                cost: '月額6,000円〜15,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['creative', 'active']
            },
            hip_hop: {
                name: 'ヒップホップダンス',
                description: 'かっこよく踊る現代的なストリートダンス',
                category: 'dance',
                icon: 'fas fa-headphones',
                benefits: ['リズム感', '自己表現', '体力向上', '創造力'],
                cost: '月額5,000円〜12,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['creative', 'active']
            },
            japanese_dance: {
                name: '日本舞踊',
                description: '日本の伝統文化を体現する美しい舞踊',
                category: 'dance',
                icon: 'fas fa-fan',
                benefits: ['伝統文化', '礼儀作法', '表現力', '姿勢改善'],
                cost: '月額8,000円〜20,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['creative', 'quiet']
            },
            cheerleading: {
                name: 'チアリーディング',
                description: '元気よく踊って人を応援するスポーツダンス',
                category: 'dance',
                icon: 'fas fa-pom-poms',
                benefits: ['チームワーク', '体力向上', '表現力', 'ポジティブ思考'],
                cost: '月額6,000円〜15,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週2回 90分',
                traits: ['active', 'social']
            },
            theater: {
                name: '演劇',
                description: '演技を通じて表現力とコミュニケーション力を育む',
                category: 'performance',
                icon: 'fas fa-theater-masks',
                benefits: ['表現力', 'コミュニケーション力', '自信向上', '協調性'],
                cost: '月額6,000円〜15,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 120分',
                traits: ['creative', 'social']
            },

            // 文化・教養系 (5種類)
            tea_ceremony: {
                name: '茶道',
                description: '日本の伝統文化で心を整え礼儀を学ぶ',
                category: 'culture',
                icon: 'fas fa-leaf',
                benefits: ['礼儀作法', '集中力', '伝統文化', '心の平静'],
                cost: '月額5,000円〜15,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['quiet', 'creative']
            },
            flower_arrangement: {
                name: '華道',
                description: '花を通じて美的感覚と集中力を育む',
                category: 'culture',
                icon: 'fas fa-seedling',
                benefits: ['美的感覚', '集中力', '伝統文化', '心の豊かさ'],
                cost: '月額6,000円〜15,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['quiet', 'creative']
            },
            go: {
                name: '囲碁',
                description: '戦略的思考力を鍛える古典的なボードゲーム',
                category: 'culture',
                icon: 'fas fa-chess',
                benefits: ['戦略的思考', '集中力', '忍耐力', '論理的思考'],
                cost: '月額3,000円〜8,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['logical', 'quiet']
            },
            shogi: {
                name: '将棋',
                description: '日本の伝統的な戦略ゲームで思考力を鍛える',
                category: 'culture',
                icon: 'fas fa-chess-king',
                benefits: ['戦略的思考', '集中力', '記憶力', '先読み能力'],
                cost: '月額3,000円〜8,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['logical', 'quiet']
            },
            cooking: {
                name: '料理教室',
                description: '食材と向き合い創造力と生活力を身につける',
                category: 'culture',
                icon: 'fas fa-utensils',
                benefits: ['生活力', '創造力', '栄養知識', '達成感'],
                cost: '月額5,000円〜12,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 120分',
                traits: ['creative', 'logical']
            }
        };

        // Categories for chart display
        var categoryLabels = {
            sports: 'スポーツ',
            martial_arts: '武道',
            music: '音楽',
            study: '学習',
            art: '芸術',
            dance: 'ダンス',
            performance: 'パフォーマンス',
            culture: '文化・教養'
        };

        // Enhanced scoring algorithm for 100+ activities
        function calculateActivityScores(answers) {
            debugLog('Calculating activity scores for 100+ activities...');
            
            var scores = {};
            var categoryScores = {};
            
            // Initialize scores for all activities
            Object.keys(activities).forEach(function(key) {
                scores[key] = 0;
            });
            
            // Initialize category scores
            Object.keys(categoryLabels).forEach(function(key) {
                categoryScores[key] = 0;
            });

            // Age-based scoring
            var age = answers.age;
            Object.keys(activities).forEach(function(key) {
                var activity = activities[key];
                var ageRange = activity.ageRange;
                
                // Parse age range and check compatibility
                if (ageRange.includes('3歳') && (age === '3-4' || age === '5-6')) {
                    scores[key] += 20;
                } else if (ageRange.includes('6歳') && ['7-9', '10-12'].includes(age)) {
                    scores[key] += 25;
                } else if (ageRange.includes('10歳') && ['10-12', '13-15'].includes(age)) {
                    scores[key] += 25;
                } else if (ageRange.includes('12歳') && ['13-15', '16-18'].includes(age)) {
                    scores[key] += 25;
                }
            });

            // Personality-based scoring
            var personality = answers.personality;
            Object.keys(activities).forEach(function(key) {
                var activity = activities[key];
                if (activity.traits && activity.traits.includes(personality)) {
                    scores[key] += 40;
                }
                
                // Additional personality bonuses
                switch (personality) {
                    case 'active':
                        if (activity.category === 'sports' || activity.category === 'martial_arts') {
                            scores[key] += 20;
                        }
                        break;
                    case 'creative':
                        if (activity.category === 'art' || activity.category === 'music' || activity.category === 'dance') {
                            scores[key] += 20;
                        }
                        break;
                    case 'logical':
                        if (activity.category === 'study') {
                            scores[key] += 20;
                        }
                        break;
                    case 'social':
                        if (activity.benefits.includes('チームワーク') || activity.benefits.includes('協調性')) {
                            scores[key] += 15;
                        }
                        break;
                    case 'quiet':
                        if (activity.category === 'culture' || activity.category === 'art') {
                            scores[key] += 15;
                        }
                        break;
                }
            });

            // Interest-based scoring
            var interests = answers.interests;
            Object.keys(activities).forEach(function(key) {
                var activity = activities[key];
                
                switch (interests) {
                    case 'sports':
                        if (activity.category === 'sports' || activity.category === 'martial_arts') {
                            scores[key] += 50;
                        }
                        break;
                    case 'art':
                        if (activity.category === 'art' || activity.category === 'music' || activity.category === 'dance') {
                            scores[key] += 50;
                        }
                        break;
                    case 'science':
                        if (activity.category === 'study' && (key.includes('programming') || key.includes('robotics') || key.includes('science'))) {
                            scores[key] += 50;
                        }
                        break;
                    case 'language':
                        if (activity.category === 'study' && (key.includes('english') || key.includes('chinese') || key.includes('french') || key.includes('korean'))) {
                            scores[key] += 50;
                        }
                        break;
                    case 'performance':
                        if (activity.category === 'dance' || activity.category === 'performance' || activity.category === 'music') {
                            scores[key] += 50;
                        }
                        break;
                }
            });

            // Energy level scoring
            var energy = answers.energy;
            Object.keys(activities).forEach(function(key) {
                var activity = activities[key];
                
                switch (energy) {
                    case 'high':
                    case 'medium-high':
                        if (activity.category === 'sports' || activity.category === 'martial_arts' || activity.category === 'dance') {
                            scores[key] += 30;
                        }
                        break;
                    case 'medium-low':
                    case 'low':
                        if (activity.category === 'culture' || activity.category === 'art' || (activity.category === 'study' && !key.includes('robotics'))) {
                            scores[key] += 20;
                        }
                        break;
                }
            });

            // Budget considerations
            var budget = answers.budget;
            Object.keys(activities).forEach(function(key) {
                var activity = activities[key];
                var cost = activity.cost;
                
                if (budget === 'low' && (cost.includes('3,000円') || cost.includes('4,000円') || cost.includes('5,000円'))) {
                    scores[key] += 15;
                } else if (budget === 'high' && cost.includes('20,000円')) {
                    scores[key] += 10;
                }
            });

            // Calculate category scores for chart
            Object.keys(activities).forEach(function(key) {
                var activity = activities[key];
                var category = activity.category;
                if (!categoryScores[category]) {
                    categoryScores[category] = 0;
                }
                categoryScores[category] += scores[key];
            });

            // Normalize category scores
            var maxCategoryScore = Math.max(...Object.values(categoryScores));
            if (maxCategoryScore > 0) {
                Object.keys(categoryScores).forEach(function(key) {
                    categoryScores[key] = Math.round((categoryScores[key] / maxCategoryScore) * 100);
                });
            }

            debugLog('Calculated scores for ' + Object.keys(scores).length + ' activities');
            return { activityScores: scores, categoryScores: categoryScores };
        }

        function getTopRecommendations(activityScores, count = 10) {
            var sortedActivities = Object.keys(activityScores)
                .map(function(key) {
                    return { name: key, score: activityScores[key] };
                })
                .sort(function(a, b) {
                    return b.score - a.score;
                })
                .slice(0, count);

            debugLog('Top ' + count + ' recommendations: ' + JSON.stringify(sortedActivities.slice(0, 3)));
            return sortedActivities;
        }

        function getPersonalityType(answers) {
            var personality = answers.personality;
            var types = {
                'active': '活発タイプ',
                'creative': '創造タイプ',
                'logical': '思考タイプ',
                'social': '社交タイプ',
                'quiet': '集中タイプ'
            };
            return types[personality] || '未分類';
        }

        // DOM manipulation functions
        function showScreen(screenId) {
            debugLog('Showing screen: ' + screenId);
            
            var screens = ['welcome-screen', 'question-screen', 'loading-screen', 'result-screen', 'history-screen'];
            screens.forEach(function(id) {
                var element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                }
            });

            var targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                targetScreen.classList.add('animate-fade-in');
            }

            // Show/hide progress bar
            var progressContainer = document.getElementById('progress-container');
            if (screenId === 'question-screen') {
                progressContainer.classList.remove('hidden');
            } else {
                progressContainer.classList.add('hidden');
            }
        }

        function updateProgress() {
            var progress = ((appState.currentQuestion + 1) / questions.length) * 100;
            var progressBar = document.getElementById('progress-bar');
            var progressText = document.getElementById('progress-text');
            
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
            if (progressText) {
                progressText.textContent = (appState.currentQuestion + 1) + '/' + questions.length;
            }
        }

        function renderQuestion() {
            var question = questions[appState.currentQuestion];
            if (!question) return;

            debugLog('Rendering question: ' + question.id);

            var titleElement = document.getElementById('question-title');
            var contentElement = document.getElementById('question-content');
            var nextBtn = document.getElementById('next-btn');
            var prevBtn = document.getElementById('prev-btn');

            if (titleElement) {
                titleElement.textContent = question.title;
            }

            if (contentElement) {
                contentElement.innerHTML = '';
                
                question.options.forEach(function(option) {
                    var optionDiv = document.createElement('div');
                    optionDiv.className = 'bg-gray-50 hover:bg-blue-50 rounded-lg p-4 cursor-pointer border-2 border-transparent transition-all';
                    
                    var input = document.createElement('input');
                    input.type = 'radio';
                    input.name = question.id;
                    input.value = option.value;
                    input.id = question.id + '_' + option.value;
                    input.className = 'mr-3';
                    
                    var label = document.createElement('label');
                    label.htmlFor = input.id;
                    label.textContent = option.label;
                    label.className = 'cursor-pointer flex-1';
                    
                    optionDiv.appendChild(input);
                    optionDiv.appendChild(label);
                    
                    // Add click handler for the entire div
                    optionDiv.addEventListener('click', function() {
                        input.checked = true;
                        updateQuestionState();
                        
                        // Visual feedback
                        var allOptions = contentElement.querySelectorAll('div');
                        allOptions.forEach(function(opt) {
                            opt.classList.remove('border-blue-500', 'bg-blue-50');
                            opt.classList.add('border-transparent');
                        });
                        optionDiv.classList.add('border-blue-500', 'bg-blue-50');
                    });
                    
                    contentElement.appendChild(optionDiv);
                });
            }

            // Update button states
            if (prevBtn) {
                if (appState.currentQuestion > 0) {
                    prevBtn.classList.remove('hidden');
                } else {
                    prevBtn.classList.add('hidden');
                }
            }

            if (nextBtn) {
                nextBtn.disabled = true;
                nextBtn.classList.add('opacity-50');
            }

            updateProgress();
        }

        function updateQuestionState() {
            var question = questions[appState.currentQuestion];
            var selectedInput = document.querySelector('input[name="' + question.id + '"]:checked');
            var nextBtn = document.getElementById('next-btn');
            
            if (selectedInput && nextBtn) {
                appState.answers[question.id] = selectedInput.value;
                nextBtn.disabled = false;
                nextBtn.classList.remove('opacity-50');
                debugLog('Answer recorded: ' + question.id + ' = ' + selectedInput.value);
            }
        }

        function nextQuestion() {
            if (appState.currentQuestion < questions.length - 1) {
                appState.currentQuestion++;
                renderQuestion();
            } else {
                // All questions answered, show loading and calculate result
                showLoading();
            }
        }

        function prevQuestion() {
            if (appState.currentQuestion > 0) {
                appState.currentQuestion--;
                renderQuestion();
                
                // Restore previous answer
                var question = questions[appState.currentQuestion];
                var previousAnswer = appState.answers[question.id];
                if (previousAnswer) {
                    var input = document.querySelector('input[value="' + previousAnswer + '"]');
                    if (input) {
                        input.checked = true;
                        input.closest('div').classList.add('border-blue-500', 'bg-blue-50');
                        updateQuestionState();
                    }
                }
            }
        }

        function showLoading() {
            showScreen('loading-screen');
            
            // Simulate calculation time
            setTimeout(function() {
                calculateResults();
            }, 2000);
        }

        function calculateResults() {
            debugLog('Calculating final results...');
            
            var scoreResults = calculateActivityScores(appState.answers);
            var topRecommendations = getTopRecommendations(scoreResults.activityScores, 10);
            var personalityType = getPersonalityType(appState.answers);
            
            appState.result = {
                activityScores: scoreResults.activityScores,
                categoryScores: scoreResults.categoryScores,
                topRecommendations: topRecommendations,
                personalityType: personalityType,
                timestamp: new Date(),
                answers: Object.assign({}, appState.answers)
            };
            
            renderResults();
            showScreen('result-screen');
        }

        function renderResults() {
            var result = appState.result;
            if (!result) return;

            debugLog('Rendering results...');

            // Render personality result
            var personalityElement = document.getElementById('personality-result');
            if (personalityElement) {
                personalityElement.innerHTML = '<div class="text-lg"><strong>' + result.personalityType + '</strong></div><p class="mt-2 text-gray-700">お子様の性格特性に基づいて、100種類以上の習い事から最適なものをご提案します。</p>';
            }

            // Render chart with category scores
            renderChart(result.categoryScores);

            // Render top 10 recommendations
            var recommendationsElement = document.getElementById('recommendations');
            if (recommendationsElement) {
                recommendationsElement.innerHTML = '';
                
                result.topRecommendations.forEach(function(rec, index) {
                    var activity = activities[rec.name];
                    if (!activity) return;
                    
                    var rank = index + 1;
                    var cardDiv = document.createElement('div');
                    
                    // Different styling for different ranks
                    var bgClass = 'bg-gradient-to-br from-blue-400 to-blue-600';
                    if (rank <= 3) {
                        bgClass = 'bg-gradient-to-br from-yellow-400 to-orange-500';
                    } else if (rank <= 6) {
                        bgClass = 'bg-gradient-to-br from-green-400 to-blue-500';
                    }
                    
                    cardDiv.className = bgClass + ' rounded-xl p-4 text-white relative overflow-hidden shadow-lg';
                    
                    cardDiv.innerHTML = 
                        '<div class="relative z-10">' +
                        '<div class="flex justify-between items-start mb-3">' +
                        '<div class="text-2xl font-bold">' + rank + '位</div>' +
                        '<i class="' + activity.icon + ' text-2xl"></i>' +
                        '</div>' +
                        '<h4 class="text-lg font-bold mb-2">' + activity.name + '</h4>' +
                        '<p class="text-sm opacity-90 mb-3">' + activity.description + '</p>' +
                        '<div class="space-y-1 text-xs">' +
                        '<div><i class="fas fa-yen-sign mr-1"></i>' + activity.cost + '</div>' +
                        '<div><i class="fas fa-clock mr-1"></i>' + activity.timeCommitment + '</div>' +
                        '<div><i class="fas fa-users mr-1"></i>' + activity.ageRange + '</div>' +
                        '</div>' +
                        '<div class="mt-3 text-xs opacity-80">' +
                        '<div><i class="fas fa-star mr-1"></i>スコア: ' + rec.score + '点</div>' +
                        '</div>' +
                        '</div>';
                    
                    recommendationsElement.appendChild(cardDiv);
                });
            }
        }

        function renderChart(categoryScores) {
            var ctx = document.getElementById('aptitude-chart');
            if (!ctx) return;
            
            var labels = Object.keys(categoryScores).map(function(key) {
                return categoryLabels[key] || key;
            });
            var data = Object.values(categoryScores);
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '適性スコア',
                        data: data,
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(99, 102, 241, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function saveResult() {
            var result = appState.result;
            if (!result) return;
            
            try {
                var history = JSON.parse(localStorage.getItem('activityHistory') || '[]');
                history.unshift(result);
                if (history.length > 10) {
                    history = history.slice(0, 10); // Keep only last 10 results
                }
                localStorage.setItem('activityHistory', JSON.stringify(history));
                
                alert('診断結果を保存しました！');
                debugLog('Result saved to localStorage');
            } catch (error) {
                debugLog('Error saving result: ' + error.message);
                alert('保存に失敗しました。ブラウザの設定をご確認ください。');
            }
        }

        function shareResult() {
            if (!navigator.share) {
                alert('お使いのブラウザではシェア機能が利用できません。');
                return;
            }

            const result = appState.result;
            if (!result) return;

            const topActivity = result.topRecommendations[0];
            const activityName = activities[topActivity.name] ? activities[topActivity.name].name : topActivity.name;
            const shareText = `【子供の習い事診断結果】\n\nおすすめの習い事：${activityName}\n性格タイプ：${result.personalityType}\n\n100種類以上から最適な習い事を診断！\nhttps://appadaycreator.github.io/kids-activity-finder/`;

            navigator.share({
                title: '子供の習い事診断結果',
                text: shareText,
                url: 'https://appadaycreator.github.io/kids-activity-finder/'
            })
            .then(() => {
                debugLog('Share successful');
            })
            .catch((error) => {
                debugLog('Share failed: ' + error);
                alert('シェアに失敗しました。');
            });
        }

        function showHistory() {
            try {
                var history = JSON.parse(localStorage.getItem('activityHistory') || '[]');
                var historyContent = document.getElementById('history-content');
                
                if (historyContent) {
                    if (history.length === 0) {
                        historyContent.innerHTML = '<p class="text-gray-600 text-center py-8">まだ診断履歴がありません。</p>';
                    } else {
                        historyContent.innerHTML = '';
                        
                        history.forEach(function(item, index) {
                            var date = new Date(item.timestamp);
                            var dateStr = date.getFullYear() + '/' + (date.getMonth() + 1) + '/' + date.getDate() + ' ' + 
                                         date.getHours() + ':' + ('0' + date.getMinutes()).slice(-2);
                            
                            var historyItem = document.createElement('div');
                            historyItem.className = 'bg-gray-50 rounded-lg p-4 mb-4';
                            historyItem.innerHTML = 
                                '<div class="flex justify-between items-start mb-2">' +
                                '<h4 class="font-bold">診断結果 #' + (index + 1) + '</h4>' +
                                '<span class="text-sm text-gray-500">' + dateStr + '</span>' +
                                '</div>' +
                                '<p class="text-sm text-gray-600 mb-2">性格タイプ: ' + item.personalityType + '</p>' +
                                '<div class="text-sm">' +
                                '<strong>TOP3:</strong> ' +
                                item.topRecommendations.slice(0, 3).map(function(rec) {
                                    return activities[rec.name] ? activities[rec.name].name : rec.name;
                                }).join(', ') +
                                '</div>';
                            
                            historyContent.appendChild(historyItem);
                        });
                    }
                }
                
                showScreen('history-screen');
            } catch (error) {
                debugLog('Error loading history: ' + error.message);
                alert('履歴の読み込みに失敗しました。');
            }
        }

        function resetDiagnosis() {
            debugLog('Resetting diagnosis...');
            
            appState.currentQuestion = 0;
            appState.answers = {};
            appState.result = null;
            appState.startTime = new Date();
            
            showScreen('welcome-screen');
        }

        // Event listeners
        function initializeEventListeners() {
            debugLog('Initializing event listeners...');
            
            var startBtn = document.getElementById('start-btn');
            if (startBtn) {
                startBtn.addEventListener('click', function() {
                    debugLog('Start button clicked');
                    appState.startTime = new Date();
                    showScreen('question-screen');
                    renderQuestion();
                });
            }

            var nextBtn = document.getElementById('next-btn');
            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    debugLog('Next button clicked');
                    nextQuestion();
                });
            }

            var prevBtn = document.getElementById('prev-btn');
            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    debugLog('Previous button clicked');
                    prevQuestion();
                });
            }

            var shareBtn = document.getElementById('share-btn');
            if (shareBtn) {
                shareBtn.addEventListener('click', function() {
                    debugLog('Share button clicked');
                    shareResult();
                });
            }

            var saveBtn = document.getElementById('save-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    debugLog('Save button clicked');
                    saveResult();
                });
            }

            var compareBtn = document.getElementById('compare-btn');
            if (compareBtn) {
                compareBtn.addEventListener('click', function() {
                    debugLog('Compare button clicked');
                    showHistory();
                });
            }

            var retryBtn = document.getElementById('retry-btn');
            if (retryBtn) {
                retryBtn.addEventListener('click', function() {
                    debugLog('Retry button clicked');
                    resetDiagnosis();
                });
            }

            var backToResultBtn = document.getElementById('back-to-result-btn');
            if (backToResultBtn) {
                backToResultBtn.addEventListener('click', function() {
                    debugLog('Back to result button clicked');
                    showScreen('result-screen');
                });
            }

            debugLog('Event listeners initialized');
        }

        // Initialize application
        function initializeApp() {
            debugLog('Initializing application...');
            
            try {
                initializeEventListeners();
                
                // Initialize state
                appState.startTime = new Date();
                
                debugLog('Application initialized successfully with ' + Object.keys(activities).length + ' activities');
            } catch (error) {
                debugLog('Error initializing application: ' + error.message);
                console.error('Application initialization error:', error);
            }
        }

        // Start the application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Service Worker registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        debugLog('SW registered successfully');
                    })
                    .catch(function(registrationError) {
                        debugLog('SW registration failed: ' + registrationError);
                    });
            });
        }

        debugLog('Script loaded successfully with ' + Object.keys(activities).length + ' activities in database');
    </script>
</body>
</html>