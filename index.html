<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>子供の習い事診断 - お子様にぴったりの習い事を見つけよう</title>
    <meta name="description" content="性格と興味から最適な習い事を診断。プログラミング、英会話、スポーツ、音楽など幅広くサポート">
    
    <!-- OGP Meta Tags -->
    <meta property="og:title" content="子供の習い事診断 - お子様にぴったりの習い事を見つけよう">
    <meta property="og:description" content="性格と興味から最適な習い事を診断。プログラミング、英会話、スポーツ、音楽など幅広くサポート">
    <meta property="og:image" content="https://cdn1.genspark.ai/user-upload-image/22_generated/1b2b567c-0e98-49ba-9ed5-13daec7598d5">
    <meta property="og:url" content="https://appadaycreator.github.io/kids-activity-finder/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- PWA Meta -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi5a2Q5L6b44Gu57+S44GE5LqL6Kit5pat44CCIiwic2hvcnRfbmFtZSI6Iue/kuOBhOS6i+ioo+aWrSIsImRlc2NyaXB0aW9uIjoi44GK5a2Q5qeY44Gr44G044Gj44Gf44KK44Gu57+S44GE5LqL44KS6KaL44Gk44GR44KI44GGIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmOGZhZmMiLCJ0aGVtZV9jb2xvciI6IiM2MzY2ZjEifQ==">
    <meta name="theme-color" content="#6366f1">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzYzNjZmMSIvPgo8cGF0aCBkPSJNOSAxMmg2djJIOXYtMnptMCA0aDEwdjJIOXYtMnptMCA0aDh2Mkg5di0yeiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+">
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TXQGZRF9');</script>
    <!-- End Google Tag Manager -->
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .result-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }
        .result-card:nth-child(2) {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .result-card:nth-child(3) {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TXQGZRF9"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <!-- Header -->
    <header class="gradient-bg text-white py-6">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl font-bold text-center">
                <i class="fas fa-child mr-2"></i>
                子供の習い事診断
            </h1>
            <p class="text-center mt-2 text-lg opacity-90">お子様にぴったりの習い事を見つけよう</p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="max-w-2xl mx-auto animate-fade-in">
            <div class="bg-white rounded-xl card-shadow p-8 text-center">
                <img src="https://cdn1.genspark.ai/user-upload-image/22_generated/1b2b567c-0e98-49ba-9ed5-13daec7598d5" 
                     alt="子供の習い事のイメージ" class="w-full max-w-md mx-auto rounded-lg mb-6">
                
                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-star text-yellow-500 mr-2"></i>
                    お子様の可能性を発見しよう！
                </h2>
                <p class="text-gray-600 mb-6 text-lg">
                    性格分析と適性診断で、お子様にぴったりの習い事をご提案します。<br>
                    科学的なアプローチで、お子様の隠れた才能を見つけてみませんか？
                </p>
                
                <div class="grid md:grid-cols-2 gap-6 mb-8">
                    <div class="text-center">
                        <i class="fas fa-bullseye text-4xl text-blue-500 mb-3"></i>
                        <h3 class="font-bold text-lg">適性マッチング</h3>
                        <p class="text-gray-600">興味と能力に最適な習い事を提案</p>
                    </div>
                    <div class="text-center">
                        <i class="fas fa-chart-bar text-4xl text-green-500 mb-3"></i>
                        <h3 class="font-bold text-lg">詳細レポート</h3>
                        <p class="text-gray-600">具体的な理由と教室情報をお届け</p>
                    </div>
                </div>
                
                <p class="text-sm text-gray-500 mb-6">
                    <i class="fas fa-clock mr-1"></i>所要時間：約3分 | 
                    <i class="fas fa-save mr-1"></i>診断結果は保存されます
                </p>
                
                <button id="start-btn" class="btn-primary text-white py-4 px-8 rounded-full text-xl font-bold w-full">
                    <i class="fas fa-play mr-2"></i>診断をスタート
                </button>
            </div>
        </div>

        <!-- Progress Bar -->
        <div id="progress-container" class="max-w-2xl mx-auto mb-6 hidden">
            <div class="bg-white rounded-xl card-shadow p-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">進捗状況</span>
                    <span id="progress-text" class="text-sm font-medium text-blue-600">1/6</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progress-bar" class="progress-bar bg-blue-600 h-3 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Question Screen -->
        <div id="question-screen" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-xl card-shadow p-8">
                <h2 id="question-title" class="text-2xl font-bold text-gray-800 mb-6 text-center"></h2>
                <div id="question-content" class="space-y-4"></div>
                <div class="flex justify-between mt-8">
                    <button id="prev-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-lg font-medium hidden">
                        <i class="fas fa-arrow-left mr-2"></i>前に戻る
                    </button>
                    <button id="next-btn" class="btn-primary text-white py-3 px-6 rounded-lg font-medium ml-auto" disabled>
                        次へ進む<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-xl card-shadow p-8 text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">診断結果を計算中...</h3>
                <p class="text-gray-600">お子様の適性を分析しています</p>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="max-w-4xl mx-auto hidden">
            <div class="bg-white rounded-xl card-shadow p-8">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-8">
                    <i class="fas fa-trophy text-yellow-500 mr-2"></i>
                    診断結果
                </h2>
                
                <!-- Personality Analysis -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-user-check mr-2"></i>性格分析結果
                    </h3>
                    <div id="personality-result" class="bg-blue-50 rounded-lg p-4"></div>
                </div>

                <!-- Chart -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-radar mr-2"></i>適性チャート
                    </h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <canvas id="aptitude-chart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Top 3 Recommendations -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-medal mr-2"></i>おすすめ習い事 TOP3
                    </h3>
                    <div id="recommendations" class="grid md:grid-cols-3 gap-6"></div>
                </div>

                <!-- Action Buttons -->
                <div class="text-center space-y-4">
                    <div class="flex flex-wrap justify-center gap-4">
                        <button id="share-btn" class="bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-medium">
                            <i class="fab fa-twitter mr-2"></i>結果をシェア
                        </button>
                        <button id="save-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-medium">
                            <i class="fas fa-save mr-2"></i>結果を保存
                        </button>
                        <button id="compare-btn" class="bg-purple-500 hover:bg-purple-600 text-white py-3 px-6 rounded-lg font-medium">
                            <i class="fas fa-users mr-2"></i>友達と比較
                        </button>
                        <button id="retry-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-lg font-medium">
                            <i class="fas fa-redo mr-2"></i>もう一度診断
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Screen -->
        <div id="history-screen" class="max-w-4xl mx-auto hidden">
            <div class="bg-white rounded-xl card-shadow p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-history mr-2"></i>診断履歴
                </h2>
                <div id="history-content"></div>
                <button id="back-to-result-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-medium mt-6">
                    <i class="fas fa-arrow-left mr-2"></i>結果に戻る
                </button>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-8 mt-16">
        <div class="container mx-auto px-4">
            <div class="grid md:grid-cols-3 gap-8">
                <div>
                    <h3 class="text-lg font-bold mb-4">子供の習い事診断 Pro</h3>
                    <p class="text-gray-300">科学的アプローチでお子様の可能性を発見し、最適な習い事をご提案します。</p>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">リンク</h3>
                    <ul class="space-y-2 text-gray-300">
                        <li><a href="#" class="hover:text-white">プライバシーポリシー</a></li>
                        <li><a href="#" class="hover:text-white">免責事項</a></li>
                        <li><a href="#" class="hover:text-white">お問い合わせ</a></li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-bold mb-4">フォローする</h3>
                    <a href="https://x.com/appadaycreator" class="text-blue-400 hover:text-blue-300">
                        <i class="fab fa-twitter mr-2"></i>@appadaycreator
                    </a>
                </div>
            </div>
            <div class="border-t border-gray-700 mt-8 pt-4 text-center text-gray-400">
                <p>&copy; 2025 App a Day Creator. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        // Debug function
        function debugLog(message) {
            console.log('[習い事診断] ' + message);
        }

        // Application state
        var appState = {
            currentQuestion: 0,
            answers: {},
            result: null,
            startTime: null
        };

        // Questions data
        var questions = [
            {
                id: 'age',
                title: 'お子様の年齢を教えてください',
                type: 'radio',
                options: [
                    { value: '3-4', label: '3-4歳（幼稚園年少）' },
                    { value: '5-6', label: '5-6歳（幼稚園年中・年長）' },
                    { value: '7-9', label: '7-9歳（小学校低学年）' },
                    { value: '10-12', label: '10-12歳（小学校高学年）' },
                    { value: '13-15', label: '13-15歳（中学生）' },
                    { value: '16-18', label: '16-18歳（高校生）' }
                ]
            },
            {
                id: 'personality',
                title: 'お子様の性格に最も近いものは？',
                type: 'radio',
                options: [
                    { value: 'active', label: '活発で体を動かすのが好き' },
                    { value: 'creative', label: '創造的で芸術的なことが好き' },
                    { value: 'logical', label: '論理的で考えることが好き' },
                    { value: 'social', label: '社交的で人と話すのが好き' },
                    { value: 'quiet', label: '静かで集中して取り組むのが好き' }
                ]
            },
            {
                id: 'interests',
                title: 'お子様が最も興味を示すのは？',
                type: 'radio',
                options: [
                    { value: 'sports', label: 'スポーツ・運動' },
                    { value: 'art', label: '絵画・工作・音楽' },
                    { value: 'science', label: '実験・プログラミング・数学' },
                    { value: 'language', label: '読書・言語・コミュニケーション' },
                    { value: 'performance', label: '演技・ダンス・発表' }
                ]
            },
            {
                id: 'energy',
                title: 'お子様の体力レベルは？',
                type: 'radio',
                options: [
                    { value: 'high', label: 'とても高い（常に元気いっぱい）' },
                    { value: 'medium-high', label: '高い（活発に動き回る）' },
                    { value: 'medium', label: '普通（適度に活動する）' },
                    { value: 'medium-low', label: 'やや低い（ゆったりと過ごす）' },
                    { value: 'low', label: '低い（静かな活動を好む）' }
                ]
            },
            {
                id: 'budget',
                title: '月額予算はどれくらいですか？',
                type: 'radio',
                options: [
                    { value: 'low', label: '〜5,000円' },
                    { value: 'medium-low', label: '5,000円〜10,000円' },
                    { value: 'medium', label: '10,000円〜15,000円' },
                    { value: 'medium-high', label: '15,000円〜20,000円' },
                    { value: 'high', label: '20,000円以上' }
                ]
            },
            {
                id: 'transportation',
                title: '送迎について教えてください',
                type: 'radio',
                options: [
                    { value: 'easy', label: '平日・休日ともに送迎可能' },
                    { value: 'weekend', label: '休日のみ送迎可能' },
                    { value: 'near', label: '近所の教室なら送迎可能' },
                    { value: 'online', label: 'オンラインレッスン希望' },
                    { value: 'difficult', label: '送迎は困難' }
                ]
            }
        ];

        // Activities database
        var activities = {
            programming: {
                name: 'プログラミング教室',
                description: '論理的思考力と創造力を育む現代的なスキル',
                icon: 'fas fa-code',
                benefits: ['論理的思考力の向上', '創造力の発達', '将来性の高いスキル', '問題解決能力の育成'],
                cost: '月額8,000円〜15,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 60分',
                affiliateUrl: 'https://example.com/programming'
            },
            english: {
                name: '英会話スクール',
                description: 'グローバル社会で活躍する語学力を身につける',
                icon: 'fas fa-globe',
                benefits: ['国際的なコミュニケーション能力', '異文化理解', '将来の選択肢拡大', '自信の向上'],
                cost: '月額6,000円〜12,000円',
                ageRange: '3歳〜18歳',
                timeCommitment: '週1-2回 45分',
                affiliateUrl: 'https://example.com/english'
            },
            sports: {
                name: 'スポーツクラブ',
                description: '健康的な体作りとチームワークを学ぶ',
                icon: 'fas fa-running',
                benefits: ['体力向上', 'チームワーク', '集中力向上', 'ストレス発散'],
                cost: '月額4,000円〜10,000円',
                ageRange: '4歳〜18歳',
                timeCommitment: '週1-2回 90分',
                affiliateUrl: 'https://example.com/sports'
            },
            music: {
                name: '音楽教室',
                description: '豊かな感性と表現力を育む芸術教育',
                icon: 'fas fa-music',
                benefits: ['感性の向上', '集中力の向上', '表現力の発達', 'ストレス軽減'],
                cost: '月額6,000円〜15,000円',
                ageRange: '3歳〜18歳',
                timeCommitment: '週1回 30-60分',
                affiliateUrl: 'https://example.com/music'
            },
            art: {
                name: '美術・工作教室',
                description: '創造力と表現力を自由に伸ばす',
                icon: 'fas fa-palette',
                benefits: ['創造力の発達', '集中力向上', '表現力向上', '手先の器用さ'],
                cost: '月額5,000円〜12,000円',
                ageRange: '3歳〜18歳',
                timeCommitment: '週1回 60-90分',
                affiliateUrl: 'https://example.com/art'
            },
            dance: {
                name: 'ダンス教室',
                description: 'リズム感と表現力、そして自信を育む',
                icon: 'fas fa-play',
                benefits: ['リズム感の向上', '表現力の発達', '体力向上', '自信の向上'],
                cost: '月額5,000円〜10,000円',
                ageRange: '3歳〜18歳',
                timeCommitment: '週1回 60分',
                affiliateUrl: 'https://example.com/dance'
            }
        };

        // Scoring algorithm
        function calculateActivityScores(answers) {
            debugLog('Calculating activity scores...');
            
            var scores = {
                programming: 0,
                english: 0,
                sports: 0,
                music: 0,
                art: 0,
                dance: 0
            };

            // Age scoring
            var age = answers.age;
            if (age === '7-9' || age === '10-12') {
                scores.programming += 30;
            } else if (age === '13-15' || age === '16-18') {
                scores.programming += 40;
            }

            // Personality scoring
            var personality = answers.personality;
            switch (personality) {
                case 'active':
                    scores.sports += 40;
                    scores.dance += 30;
                    break;
                case 'creative':
                    scores.art += 40;
                    scores.music += 35;
                    scores.dance += 25;
                    break;
                case 'logical':
                    scores.programming += 45;
                    scores.music += 20;
                    break;
                case 'social':
                    scores.english += 40;
                    scores.dance += 30;
                    scores.sports += 25;
                    break;
                case 'quiet':
                    scores.art += 35;
                    scores.programming += 30;
                    scores.music += 30;
                    break;
            }

            // Interest scoring
            var interests = answers.interests;
            switch (interests) {
                case 'sports':
                    scores.sports += 50;
                    break;
                case 'art':
                    scores.art += 50;
                    scores.music += 30;
                    break;
                case 'science':
                    scores.programming += 50;
                    break;
                case 'language':
                    scores.english += 50;
                    break;
                case 'performance':
                    scores.dance += 50;
                    scores.music += 30;
                    break;
            }

            // Energy level scoring
            var energy = answers.energy;
            switch (energy) {
                case 'high':
                case 'medium-high':
                    scores.sports += 30;
                    scores.dance += 25;
                    break;
                case 'medium-low':
                case 'low':
                    scores.programming += 20;
                    scores.art += 20;
                    scores.music += 20;
                    break;
            }

            // Budget considerations
            var budget = answers.budget;
            if (budget === 'low') {
                scores.sports += 10; // Generally more affordable
            }

            debugLog('Calculated scores: ' + JSON.stringify(scores));
            return scores;
        }

        function getTopRecommendations(scores) {
            var sortedActivities = Object.keys(scores)
                .map(function(key) {
                    return { name: key, score: scores[key] };
                })
                .sort(function(a, b) {
                    return b.score - a.score;
                })
                .slice(0, 3);

            debugLog('Top recommendations: ' + JSON.stringify(sortedActivities));
            return sortedActivities;
        }

        function getPersonalityType(answers) {
            var personality = answers.personality;
            var types = {
                'active': '活発タイプ',
                'creative': '創造タイプ',
                'logical': '思考タイプ',
                'social': '社交タイプ',
                'quiet': '集中タイプ'
            };
            return types[personality] || '未分類';
        }

        // DOM manipulation functions
        function showScreen(screenId) {
            debugLog('Showing screen: ' + screenId);
            
            var screens = ['welcome-screen', 'question-screen', 'loading-screen', 'result-screen', 'history-screen'];
            screens.forEach(function(id) {
                var element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                }
            });

            var targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                targetScreen.classList.add('animate-fade-in');
            }

            // Show/hide progress bar
            var progressContainer = document.getElementById('progress-container');
            if (screenId === 'question-screen') {
                progressContainer.classList.remove('hidden');
            } else {
                progressContainer.classList.add('hidden');
            }
        }

        function updateProgress() {
            var progress = ((appState.currentQuestion + 1) / questions.length) * 100;
            var progressBar = document.getElementById('progress-bar');
            var progressText = document.getElementById('progress-text');
            
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
            if (progressText) {
                progressText.textContent = (appState.currentQuestion + 1) + '/' + questions.length;
            }
        }

        function renderQuestion() {
            var question = questions[appState.currentQuestion];
            if (!question) return;

            debugLog('Rendering question: ' + question.id);

            var titleElement = document.getElementById('question-title');
            var contentElement = document.getElementById('question-content');
            var nextBtn = document.getElementById('next-btn');
            var prevBtn = document.getElementById('prev-btn');

            if (titleElement) {
                titleElement.textContent = question.title;
            }

            if (contentElement) {
                contentElement.innerHTML = '';
                
                question.options.forEach(function(option) {
                    var optionDiv = document.createElement('div');
                    optionDiv.className = 'bg-gray-50 hover:bg-blue-50 rounded-lg p-4 cursor-pointer border-2 border-transparent transition-all';
                    
                    var input = document.createElement('input');
                    input.type = 'radio';
                    input.name = question.id;
                    input.value = option.value;
                    input.id = question.id + '_' + option.value;
                    input.className = 'mr-3';
                    
                    var label = document.createElement('label');
                    label.htmlFor = input.id;
                    label.textContent = option.label;
                    label.className = 'cursor-pointer flex-1';
                    
                    optionDiv.appendChild(input);
                    optionDiv.appendChild(label);
                    
                    // Add click handler for the entire div
                    optionDiv.addEventListener('click', function() {
                        input.checked = true;
                        updateQuestionState();
                        
                        // Visual feedback
                        var allOptions = contentElement.querySelectorAll('div');
                        allOptions.forEach(function(opt) {
                            opt.classList.remove('border-blue-500', 'bg-blue-50');
                            opt.classList.add('border-transparent');
                        });
                        optionDiv.classList.add('border-blue-500', 'bg-blue-50');
                    });
                    
                    contentElement.appendChild(optionDiv);
                });
            }

            // Update button states
            if (prevBtn) {
                if (appState.currentQuestion > 0) {
                    prevBtn.classList.remove('hidden');
                } else {
                    prevBtn.classList.add('hidden');
                }
            }

            if (nextBtn) {
                nextBtn.disabled = true;
                nextBtn.classList.add('opacity-50');
            }

            updateProgress();
        }

        function updateQuestionState() {
            var question = questions[appState.currentQuestion];
            var selectedInput = document.querySelector('input[name="' + question.id + '"]:checked');
            var nextBtn = document.getElementById('next-btn');
            
            if (selectedInput && nextBtn) {
                appState.answers[question.id] = selectedInput.value;
                nextBtn.disabled = false;
                nextBtn.classList.remove('opacity-50');
                debugLog('Answer recorded: ' + question.id + ' = ' + selectedInput.value);
            }
        }

        function nextQuestion() {
            if (appState.currentQuestion < questions.length - 1) {
                appState.currentQuestion++;
                renderQuestion();
            } else {
                // All questions answered, show loading and calculate result
                showLoading();
            }
        }

        function prevQuestion() {
            if (appState.currentQuestion > 0) {
                appState.currentQuestion--;
                renderQuestion();
                
                // Restore previous answer
                var question = questions[appState.currentQuestion];
                var previousAnswer = appState.answers[question.id];
                if (previousAnswer) {
                    var input = document.querySelector('input[value="' + previousAnswer + '"]');
                    if (input) {
                        input.checked = true;
                        input.closest('div').classList.add('border-blue-500', 'bg-blue-50');
                        updateQuestionState();
                    }
                }
            }
        }

        function showLoading() {
            showScreen('loading-screen');
            
            // Simulate calculation time
            setTimeout(function() {
                calculateResults();
            }, 2000);
        }

        function calculateResults() {
            debugLog('Calculating final results...');
            
            var scores = calculateActivityScores(appState.answers);
            var topRecommendations = getTopRecommendations(scores);
            var personalityType = getPersonalityType(appState.answers);
            
            appState.result = {
                scores: scores,
                topRecommendations: topRecommendations,
                personalityType: personalityType,
                timestamp: new Date(),
                answers: Object.assign({}, appState.answers)
            };
            
            renderResults();
            showScreen('result-screen');
        }

        function renderResults() {
            var result = appState.result;
            if (!result) return;

            debugLog('Rendering results...');

            // Render personality result
            var personalityElement = document.getElementById('personality-result');
            if (personalityElement) {
                personalityElement.innerHTML = '<div class="text-lg"><strong>' + result.personalityType + '</strong></div><p class="mt-2 text-gray-700">お子様の性格特性に基づいた最適な習い事をご提案します。</p>';
            }

            // Render chart
            renderChart(result.scores);

            // Render recommendations
            var recommendationsElement = document.getElementById('recommendations');
            if (recommendationsElement) {
                recommendationsElement.innerHTML = '';
                
                result.topRecommendations.forEach(function(rec, index) {
                    var activity = activities[rec.name];
                    if (!activity) return;
                    
                    var rank = index + 1;
                    var cardDiv = document.createElement('div');
                    cardDiv.className = 'result-card rounded-xl p-6 text-white relative overflow-hidden';
                    
                    cardDiv.innerHTML = 
                        '<div class="relative z-10">' +
                        '<div class="text-center mb-4">' +
                        '<div class="text-3xl font-bold">' + rank + '位</div>' +
                        '<i class="' + activity.icon + ' text-3xl mt-2"></i>' +
                        '</div>' +
                        '<h4 class="text-xl font-bold mb-2">' + activity.name + '</h4>' +
                        '<p class="text-sm opacity-90 mb-4">' + activity.description + '</p>' +
                        '<div class="space-y-2 text-sm">' +
                        '<div><i class="fas fa-yen-sign mr-2"></i>' + activity.cost + '</div>' +
                        '<div><i class="fas fa-clock mr-2"></i>' + activity.timeCommitment + '</div>' +
                        '<div><i class="fas fa-users mr-2"></i>' + activity.ageRange + '</div>' +
                        '</div>' +
                        '<button class="w-full bg-white bg-opacity-20 hover:bg-opacity-30 text-white py-2 px-4 rounded-lg mt-4 transition-all" onclick="window.open(\'' + activity.affiliateUrl + '\', \'_blank\')">' +
                        '<i class="fas fa-external-link-alt mr-2"></i>詳細を見る' +
                        '</button>' +
                        '</div>';
                    
                    recommendationsElement.appendChild(cardDiv);
                });
            }
        }

        function renderChart(scores) {
            var ctx = document.getElementById('aptitude-chart');
            if (!ctx) return;
            
            var labels = Object.keys(scores).map(function(key) {
                return activities[key] ? activities[key].name : key;
            });
            var data = Object.values(scores);
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '適性スコア',
                        data: data,
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(99, 102, 241, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function saveResult() {
            var result = appState.result;
            if (!result) return;
            
            try {
                var history = JSON.parse(localStorage.getItem('activityHistory') || '[]');
                history.unshift(result);
                if (history.length > 10) {
                    history = history.slice(0, 10); // Keep only last 10 results
                }
                localStorage.setItem('activityHistory', JSON.stringify(history));
                
                alert('診断結果を保存しました！');
                debugLog('Result saved to localStorage');
            } catch (error) {
                debugLog('Error saving result: ' + error.message);
                alert('保存に失敗しました。ブラウザの設定をご確認ください。');
            }
        }

        function shareResult() {
            if (!navigator.share) {
                alert('お使いのブラウザではシェア機能が利用できません。');
                return;
            }

            const result = appState.result;
            if (!result) return;

            const topActivity = result.topRecommendations[0];
            const shareText = `【子供の習い事診断結果】\n\nおすすめの習い事：${topActivity.name}\n\nあなたのお子様にぴったりの習い事を見つけませんか？\nhttps://appadaycreator.github.io/kids-activity-finder/`;

            navigator.share({
                title: '子供の習い事診断結果',
                text: shareText,
                url: 'https://appadaycreator.github.io/kids-activity-finder/'
            })
            .then(() => {
                debugLog('Share successful');
            })
            .catch((error) => {
                debugLog('Share failed: ' + error);
                alert('シェアに失敗しました。');
            });
        }

        function showHistory() {
            try {
                var history = JSON.parse(localStorage.getItem('activityHistory') || '[]');
                var historyContent = document.getElementById('history-content');
                
                if (historyContent) {
                    if (history.length === 0) {
                        historyContent.innerHTML = '<p class="text-gray-600 text-center py-8">まだ診断履歴がありません。</p>';
                    } else {
                        historyContent.innerHTML = '';
                        
                        history.forEach(function(item, index) {
                            var date = new Date(item.timestamp);
                            var dateStr = date.getFullYear() + '/' + (date.getMonth() + 1) + '/' + date.getDate() + ' ' + 
                                         date.getHours() + ':' + ('0' + date.getMinutes()).slice(-2);
                            
                            var historyItem = document.createElement('div');
                            historyItem.className = 'bg-gray-50 rounded-lg p-4 mb-4';
                            historyItem.innerHTML = 
                                '<div class="flex justify-between items-start mb-2">' +
                                '<h4 class="font-bold">診断結果 #' + (index + 1) + '</h4>' +
                                '<span class="text-sm text-gray-500">' + dateStr + '</span>' +
                                '</div>' +
                                '<p class="text-sm text-gray-600 mb-2">性格タイプ: ' + item.personalityType + '</p>' +
                                '<div class="text-sm">' +
                                '<strong>TOP3:</strong> ' +
                                item.topRecommendations.slice(0, 3).map(function(rec) {
                                    return activities[rec.name] ? activities[rec.name].name : rec.name;
                                }).join(', ') +
                                '</div>';
                            
                            historyContent.appendChild(historyItem);
                        });
                    }
                }
                
                showScreen('history-screen');
            } catch (error) {
                debugLog('Error loading history: ' + error.message);
                alert('履歴の読み込みに失敗しました。');
            }
        }

        function resetDiagnosis() {
            debugLog('Resetting diagnosis...');
            
            appState.currentQuestion = 0;
            appState.answers = {};
            appState.result = null;
            appState.startTime = new Date();
            
            showScreen('welcome-screen');
        }

        // Event listeners
        function initializeEventListeners() {
            debugLog('Initializing event listeners...');
            
            var startBtn = document.getElementById('start-btn');
            if (startBtn) {
                startBtn.addEventListener('click', function() {
                    debugLog('Start button clicked');
                    appState.startTime = new Date();
                    showScreen('question-screen');
                    renderQuestion();
                });
            }

            var nextBtn = document.getElementById('next-btn');
            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    debugLog('Next button clicked');
                    nextQuestion();
                });
            }

            var prevBtn = document.getElementById('prev-btn');
            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    debugLog('Previous button clicked');
                    prevQuestion();
                });
            }

            var shareBtn = document.getElementById('share-btn');
            if (shareBtn) {
                shareBtn.addEventListener('click', function() {
                    debugLog('Share button clicked');
                    shareResult();
                });
            }

            var saveBtn = document.getElementById('save-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    debugLog('Save button clicked');
                    saveResult();
                });
            }

            var compareBtn = document.getElementById('compare-btn');
            if (compareBtn) {
                compareBtn.addEventListener('click', function() {
                    debugLog('Compare button clicked');
                    showHistory();
                });
            }

            var retryBtn = document.getElementById('retry-btn');
            if (retryBtn) {
                retryBtn.addEventListener('click', function() {
                    debugLog('Retry button clicked');
                    resetDiagnosis();
                });
            }

            var backToResultBtn = document.getElementById('back-to-result-btn');
            if (backToResultBtn) {
                backToResultBtn.addEventListener('click', function() {
                    debugLog('Back to result button clicked');
                    showScreen('result-screen');
                });
            }

            debugLog('Event listeners initialized');
        }

        // Initialize application
        function initializeApp() {
            debugLog('Initializing application...');
            
            try {
                initializeEventListeners();
                
                // Initialize state
                appState.startTime = new Date();
                
                debugLog('Application initialized successfully');
            } catch (error) {
                debugLog('Error initializing application: ' + error.message);
                console.error('Application initialization error:', error);
            }
        }

        // Start the application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Service Worker registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        debugLog('SW registered successfully');
                    })
                    .catch(function(registrationError) {
                        debugLog('SW registration failed: ' + registrationError);
                    });
            });
        }

        debugLog('Script loaded successfully');
    </script>
</body>
</html>
