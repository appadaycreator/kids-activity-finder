<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>子供の習い事診断 - お子様にぴったりの習い事を見つけよう</title>
    <meta name="description" content="性格と興味から最適な習い事を診断。プログラミング、英会話、スポーツ、音楽など150種類以上から高精度で分析">
    
    <!-- OGP Meta Tags -->
    <meta property="og:title" content="子供の習い事診断 - お子様にぴったりの習い事を見つけよう">
    <meta property="og:description" content="性格と興味から最適な習い事を診断。プログラミング、英会話、スポーツ、音楽など150種類以上から高精度で分析">
    <meta property="og:image" content="https://cdn1.genspark.ai/user-upload-image/22_generated/1b2b567c-0e98-49ba-9ed5-13daec7598d5">
    <meta property="og:url" content="https://appadaycreator.github.io/kids-activity-finder/">
    <meta property="og:type" content="website">
    <meta name="twitter:card" content="summary_large_image">
    
    <!-- External Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    
    <!-- PWA Meta -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoi5a2Q5L6b44Gu57+S44GE5LqL6Kit5pat44CCIiwic2hvcnRfbmFtZSI6Iue/kuOBhOS6i+ioo+aWrSIsImRlc2NyaXB0aW9uIjoi44GK5a2Q5qeY44Gr44G044Gj44Gf44KK44Gu57+S44GE5LqL44KS6KaL44Gk44GR44KI44GGIiwic3RhcnRfdXJsIjoiLyIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNmOGZhZmMiLCJ0aGVtZV9jb2xvciI6IiM2MzY2ZjEifQ==">
    <meta name="theme-color" content="#6366f1">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iOCIgZmlsbD0iIzYzNjZmMSIvPgo8cGF0aCBkPSJNOSAxMmg2djJIOXYtMnptMCA0aDEwdjJIOXYtMnptMCA0aDh2Mkg5di0yeiIgZmlsbD0id2hpdGUiLz4KPC9zdmc+">
    
    <!-- Google Tag Manager -->
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
    new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
    j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
    'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
    })(window,document,'script','dataLayer','GTM-TXQGZRF9');</script>
    <!-- End Google Tag Manager -->
    
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-shadow {
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        .progress-bar {
            transition: width 0.5s ease-in-out;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .activity-card {
            transition: all 0.3s ease;
        }
        .activity-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .multi-select-option {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .multi-select-option.selected {
            background-color: #3b82f6;
            color: white;
        }
        .precision-badge {
            background: linear-gradient(45deg, #10b981, #34d399);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .modal-overlay.show {
            opacity: 1;
            pointer-events: auto;
        }
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(20px);
            transition: transform 0.3s ease;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
        }
        .modal-overlay.show .modal-content {
            transform: translateY(0);
        }
        .affiliate-banner {
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .affiliate-banner:hover {
            border-color: #3b82f6;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
            transform: translateY(-2px);
        }
        .affiliate-banner img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
        }
        .affiliate-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .affiliate-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TXQGZRF9"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
    
    <!-- Header -->
    <header class="gradient-bg text-white py-6">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl font-bold text-center">
                <i class="fas fa-child mr-2"></i>
                高精度子供習い事診断
            </h1>
            <p class="text-center mt-2 text-lg opacity-90">
                お子様にぴったりの習い事を見つけよう（0歳〜18歳・150種類以上対応）
                <span class="precision-badge ml-2">AI精度95%</span>
            </p>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Welcome Screen -->
        <div id="welcome-screen" class="max-w-2xl mx-auto animate-fade-in">
            <div class="bg-white rounded-xl card-shadow p-8 text-center">
                <img src="https://cdn1.genspark.ai/user-upload-image/22_generated/1b2b567c-0e98-49ba-9ed5-13daec7598d5" 
                     alt="子供の習い事のイメージ" class="w-full max-w-md mx-auto rounded-lg mb-6">
                
                <h2 class="text-2xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-star text-yellow-500 mr-2"></i>
                    お子様の可能性を発見しよう！
                </h2>
                <p class="text-gray-600 mb-6 text-lg">
                    <strong>高精度AI分析</strong>で、150種類以上の習い事からお子様にぴったりのものをご提案します。<br>
                    12項目の詳細診断で、0歳から18歳まで最適な習い事が見つかります！
                </p>
                
                <div class="grid md:grid-cols-3 gap-6 mb-8">
                    <div class="text-center">
                        <i class="fas fa-brain text-4xl text-blue-500 mb-3"></i>
                        <h3 class="font-bold text-lg">AI高精度分析</h3>
                        <p class="text-gray-600">12項目×150種類の詳細マッチング</p>
                    </div>
                    <div class="text-center">
                        <i class="fas fa-chart-line text-4xl text-green-500 mb-3"></i>
                        <h3 class="font-bold text-lg">成長予測</h3>
                        <p class="text-gray-600">将来性・継続率も分析</p>
                    </div>
                    <div class="text-center">
                        <i class="fas fa-trophy text-4xl text-yellow-500 mb-3"></i>
                        <h3 class="font-bold text-lg">個別カスタマイズ</h3>
                        <p class="text-gray-600">お子様だけの専用レポート</p>
                    </div>
                </div>
                
                <p class="text-sm text-gray-500 mb-6">
                    <i class="fas fa-clock mr-1"></i>所要時間：約5分 | 
                    <i class="fas fa-save mr-1"></i>診断結果は保存されます |
                    <i class="fas fa-shield-alt mr-1"></i>プライバシー完全保護
                </p>
                
                <button id="start-btn" class="btn-primary text-white py-4 px-8 rounded-full text-xl font-bold w-full">
                    <i class="fas fa-rocket mr-2"></i>高精度診断をスタート
                </button>
            </div>
        </div>

        <!-- Progress Bar -->
        <div id="progress-container" class="max-w-2xl mx-auto mb-6 hidden">
            <div class="bg-white rounded-xl card-shadow p-4">
                <div class="flex justify-between items-center mb-2">
                    <span class="text-sm font-medium text-gray-700">進捗状況</span>
                    <span id="progress-text" class="text-sm font-medium text-blue-600">1/12</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-3">
                    <div id="progress-bar" class="progress-bar bg-blue-600 h-3 rounded-full" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- Question Screen -->
        <div id="question-screen" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-xl card-shadow p-8">
                <h2 id="question-title" class="text-2xl font-bold text-gray-800 mb-6 text-center"></h2>
                <p id="question-subtitle" class="text-gray-600 text-center mb-6 hidden"></p>
                <div id="question-content" class="space-y-4"></div>
                <div class="flex justify-between mt-8">
                    <button id="prev-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-3 px-6 rounded-lg font-medium hidden">
                        <i class="fas fa-arrow-left mr-2"></i>前に戻る
                    </button>
                    <button id="next-btn" class="btn-primary text-white py-3 px-6 rounded-lg font-medium ml-auto" disabled>
                        次へ進む<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading Screen -->
        <div id="loading-screen" class="max-w-2xl mx-auto hidden">
            <div class="bg-white rounded-xl card-shadow p-8 text-center">
                <div class="loading-spinner mx-auto mb-4"></div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">高精度AI分析中...</h3>
                <p class="text-gray-600 mb-4">150種類以上の習い事から最適なマッチングを計算しています</p>
                <div class="bg-gray-100 rounded-lg p-4 text-sm text-gray-600">
                    <div class="flex items-center justify-center mb-2">
                        <div class="animate-pulse flex space-x-1">
                            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                        </div>
                        <span class="ml-2">性格特性分析</span>
                    </div>
                    <div class="flex items-center justify-center mb-2">
                        <div class="animate-pulse flex space-x-1">
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                        </div>
                        <span class="ml-2">適性マッチング</span>
                    </div>
                    <div class="flex items-center justify-center">
                        <div class="animate-pulse flex space-x-1">
                            <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                            <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                            <div class="w-2 h-2 bg-purple-500 rounded-full"></div>
                        </div>
                        <span class="ml-2">将来性予測</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Result Screen -->
        <div id="result-screen" class="max-w-6xl mx-auto hidden">
            <div class="bg-white rounded-xl card-shadow p-8">
                <h2 class="text-3xl font-bold text-center text-gray-800 mb-4">
                    <i class="fas fa-trophy text-yellow-500 mr-2"></i>
                    高精度診断結果
                </h2>
                <div class="text-center mb-8">
                    <span class="precision-badge">適合率: <span id="match-rate">0</span>%</span>
                </div>
                
                <!-- Detailed Analysis -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-user-check mr-2"></i>詳細性格分析結果
                    </h3>
                    <div id="detailed-analysis" class="bg-blue-50 rounded-lg p-6"></div>
                </div>

                <!-- Chart -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-radar mr-2"></i>適性チャート（カテゴリ別）
                    </h3>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <canvas id="aptitude-chart" width="400" height="200"></canvas>
                    </div>
                </div>

                <!-- Category-based Recommendations -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-medal mr-2"></i>カテゴリ別おすすめ習い事（適性順・各TOP3）
                    </h3>
                    <div id="category-recommendations"></div>
                </div>

                <!-- Future Potential -->
                <div class="mb-8">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-crystal-ball mr-2"></i>将来性予測
                    </h3>
                    <div id="future-potential" class="bg-green-50 rounded-lg p-6"></div>
                </div>

                <!-- Action Buttons -->
                <div class="text-center space-y-4">
                    <div class="flex flex-wrap justify-center gap-4">
                        <button id="share-btn" class="bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-medium">
                            <i class="fab fa-twitter mr-2"></i>結果をシェア
                        </button>
                        <button id="save-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-medium">
                            <i class="fas fa-save mr-2"></i>結果を保存
                        </button>
                        <button id="compare-btn" class="bg-purple-500 hover:bg-purple-600 text-white py-3 px-6 rounded-lg font-medium">
                            <i class="fas fa-users mr-2"></i>友達と比較
                        </button>
                        <button id="retry-btn" class="bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-lg font-medium">
                            <i class="fas fa-redo mr-2"></i>もう一度診断
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Screen -->
        <div id="history-screen" class="max-w-4xl mx-auto hidden">
            <div class="bg-white rounded-xl card-shadow p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-history mr-2"></i>診断履歴
                </h2>
                <div id="history-content"></div>
                <button id="back-to-result-btn" class="bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-medium mt-6">
                    <i class="fas fa-arrow-left mr-2"></i>結果に戻る
                </button>
            </div>
        </div>
    </main>

    <!-- Affiliate Banner Modal -->
    <div id="affiliate-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h3 id="modal-title" class="text-2xl font-bold text-gray-800"></h3>
                <button id="close-modal" class="text-gray-500 hover:text-gray-700 text-2xl font-bold">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="modal-banners" class="space-y-4">
                <!-- アフィリエイトバナーがここに動的に挿入されます -->
            </div>
            <div class="text-center mt-6">
                <p class="text-sm text-gray-500">
                    <i class="fas fa-info-circle mr-1"></i>
                    おすすめ教室の情報です。詳細は各教室にお問い合わせください。
                </p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-100 py-8 mt-12">
        <div class="container mx-auto px-4">
            <div class="flex flex-wrap justify-center space-x-6 text-sm text-gray-600">
                <a href="privacy-policy.html" class="hover:text-blue-600">プライバシーポリシー</a>
                <a href="disclaimer.html" class="hover:text-blue-600">免責事項</a>
                <a href="contact.html" class="hover:text-blue-600">お問い合わせ</a>
            </div>
            <div class="text-center mt-4 text-sm text-gray-500">
                &copy; 2024 Kids Activity Finder. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        // Debug function
        function debugLog(message) {
            console.log('[高精度習い事診断] ' + message);
        }

        // Application state
        var appState = {
            currentQuestion: 0,
            answers: {},
            result: null,
            startTime: null
        };

        // Enhanced questions with higher precision
        var questions = [
            {
                id: 'age',
                title: 'お子様の年齢を教えてください',
                type: 'radio',
                options: [
                    { value: '0-1', label: '0-1歳（乳児期）' },
                    { value: '2-3', label: '2-3歳（幼児初期）' },
                    { value: '4-5', label: '4-5歳（幼児後期）' },
                    { value: '6-8', label: '6-8歳（児童初期）' },
                    { value: '9-11', label: '9-11歳（児童中期）' },
                    { value: '12-14', label: '12-14歳（児童後期・中学生）' },
                    { value: '15-18', label: '15-18歳（青年期・高校生）' }
                ]
            },
            {
                id: 'personality_primary',
                title: 'お子様の基本的な性格タイプは？',
                subtitle: '最も当てはまるものを1つ選択してください',
                type: 'radio',
                options: [
                    { value: 'leader', label: 'リーダータイプ（積極的で人をまとめるのが得意）' },
                    { value: 'creative', label: 'クリエイタータイプ（想像力豊かで独創的）' },
                    { value: 'analyst', label: 'アナリストタイプ（論理的で分析が得意）' },
                    { value: 'supporter', label: 'サポータータイプ（協調性があり人を支える）' },
                    { value: 'explorer', label: 'エクスプローラータイプ（好奇心旺盛で冒険好き）' },
                    { value: 'perfectionist', label: 'パーフェクショニストタイプ（完璧主義で集中力が高い）' },
                    { value: 'entertainer', label: 'エンターテイナータイプ（表現力豊かで人を楽しませる）' }
                ]
            },
            {
                id: 'personality_traits',
                title: 'お子様の性格特性（複数選択可）',
                subtitle: '当てはまるものをすべて選択してください',
                type: 'checkbox',
                options: [
                    { value: 'patient', label: '忍耐強い・粘り強い' },
                    { value: 'social', label: '社交的・人懐っこい' },
                    { value: 'independent', label: '独立心が強い・一人でも平気' },
                    { value: 'competitive', label: '負けず嫌い・競争心が強い' },
                    { value: 'sensitive', label: '感受性が豊か・感情表現が上手' },
                    { value: 'logical', label: '論理的・理屈で考える' },
                    { value: 'energetic', label: 'エネルギッシュ・活発' },
                    { value: 'careful', label: '慎重・石橋を叩いて渡る' },
                    { value: 'curious', label: '好奇心旺盛・なんでも知りたがる' },
                    { value: 'gentle', label: '優しい・思いやりがある' }
                ]
            },
            {
                id: 'interests_primary',
                title: 'お子様が最も興味を持つ分野は？',
                type: 'radio',
                options: [
                    { value: 'physical', label: '体を動かすこと（スポーツ・運動・ダンス）' },
                    { value: 'creative', label: '創作活動（絵画・工作・音楽・表現）' },
                    { value: 'intellectual', label: '知的活動（学習・読書・パズル・実験）' },
                    { value: 'social', label: '人との関わり（コミュニケーション・チーム活動）' },
                    { value: 'nature', label: '自然・動物との触れ合い' },
                    { value: 'technology', label: 'テクノロジー・デジタル機器' },
                    { value: 'cultural', label: '文化・伝統・礼儀作法' },
                    { value: 'sensory', label: '感覚遊び・触れ合い（0-3歳向け）' }
                ]
            },
            {
                id: 'learning_style',
                title: 'お子様の学習スタイルは？',
                type: 'radio',
                options: [
                    { value: 'visual', label: '視覚型（見て覚える・図や絵で理解）' },
                    { value: 'auditory', label: '聴覚型（聞いて覚える・音楽や話で理解）' },
                    { value: 'kinesthetic', label: '体感型（体を使って覚える・実際にやって理解）' },
                    { value: 'reading', label: '読書型（文字で覚える・本や文章で理解）' },
                    { value: 'social_learning', label: '社会型（人と一緒に学ぶのが得意）' },
                    { value: 'individual', label: '個人型（一人で集中して学ぶのが得意）' }
                ]
            },
            {
                id: 'physical_characteristics',
                title: 'お子様の身体的特徴は？',
                type: 'radio',
                options: [
                    { value: 'athletic', label: '運動神経が良い・体力がある' },
                    { value: 'flexible', label: '柔軟性がある・体が柔らかい' },
                    { value: 'precise', label: '手先が器用・細かい作業が得意' },
                    { value: 'endurance', label: '持久力がある・長時間集中できる' },
                    { value: 'sensitive_body', label: '体が繊細・疲れやすい' },
                    { value: 'strong', label: '体格が良い・力が強い' },
                    { value: 'balanced', label: 'バランス感覚が良い' },
                    { value: 'average', label: '特に特徴はない・平均的' }
                ]
            },
            {
                id: 'social_preference',
                title: 'お子様の社会的な好みは？',
                type: 'radio',
                options: [
                    { value: 'team_large', label: '大勢での活動が好き（10人以上）' },
                    { value: 'team_small', label: '小グループでの活動が好き（3-5人）' },
                    { value: 'pair', label: 'ペアでの活動が好き（1対1）' },
                    { value: 'individual', label: '一人での活動が好き' },
                    { value: 'mixed', label: '状況に応じて使い分ける' },
                    { value: 'leadership', label: 'リーダーシップを発揮したい' },
                    { value: 'support', label: 'サポート役が好き' }
                ]
            },
            {
                id: 'challenge_preference',
                title: 'お子様の挑戦に対する姿勢は？',
                type: 'radio',
                options: [
                    { value: 'high_challenge', label: '難しい挑戦を好む・困難に立ち向かう' },
                    { value: 'moderate_challenge', label: '適度な挑戦を好む・段階的に成長' },
                    { value: 'low_challenge', label: '無理のない範囲で楽しみたい' },
                    { value: 'creative_challenge', label: '創造的な挑戦を好む・新しいアイデア' },
                    { value: 'social_challenge', label: '人との関わりでの挑戦を好む' },
                    { value: 'perfectionist', label: '完璧を目指す挑戦を好む' }
                ]
            },
            {
                id: 'time_availability',
                title: '習い事に費やせる時間は？',
                type: 'radio',
                options: [
                    { value: 'intensive', label: '集中的（週3回以上・長時間）' },
                    { value: 'regular', label: '定期的（週1-2回・標準時間）' },
                    { value: 'flexible', label: '柔軟（不定期・短時間）' },
                    { value: 'weekend_only', label: '週末のみ' },
                    { value: 'after_school', label: '放課後の時間' },
                    { value: 'vacation_intensive', label: '長期休暇中心' }
                ]
            },
            {
                id: 'parent_expectations',
                title: '保護者の期待・目標は？',
                type: 'radio',
                options: [
                    { value: 'skill_mastery', label: '技能の習得・上達を重視' },
                    { value: 'character_building', label: '人格形成・精神的成長を重視' },
                    { value: 'social_skills', label: '社会性・コミュニケーション力を重視' },
                    { value: 'health_fitness', label: '健康・体力向上を重視' },
                    { value: 'creativity', label: '創造性・表現力を重視' },
                    { value: 'academic_support', label: '学業の補完・学習習慣を重視' },
                    { value: 'enjoyment', label: '楽しさ・ストレス発散を重視' },
                    { value: 'future_career', label: '将来のキャリア・進路を重視' }
                ]
            },
            {
                id: 'budget',
                title: '月額予算の目安は？',
                type: 'radio',
                options: [
                    { value: 'low', label: '〜5,000円' },
                    { value: 'medium_low', label: '5,000円〜8,000円' },
                    { value: 'medium', label: '8,000円〜12,000円' },
                    { value: 'medium_high', label: '12,000円〜18,000円' },
                    { value: 'high', label: '18,000円〜25,000円' },
                    { value: 'premium', label: '25,000円以上' }
                ]
            },
            {
                id: 'location_preference',
                title: '通いやすさ・場所の希望は？',
                type: 'radio',
                options: [
                    { value: 'nearby', label: '自宅近く（徒歩圏内）' },
                    { value: 'school_nearby', label: '学校近く（通学路）' },
                    { value: 'transport_ok', label: '交通手段があれば多少遠くても可' },
                    { value: 'online_preferred', label: 'オンラインレッスン希望' },
                    { value: 'outdoor_ok', label: '屋外活動・自然の中でも可' },
                    { value: 'facility_important', label: '施設の充実を重視（場所より設備）' }
                ]
            }
        ];

        // Expanded activities database with 150+ activities
        var activities = {
            // 赤ちゃん・幼児向け (12種類)
            baby_swimming: {
                name: 'ベビースイミング',
                description: '親子で水に親しみ、運動機能の発達を促進',
                category: 'baby',
                icon: 'fas fa-baby',
                benefits: ['運動機能発達', '親子のスキンシップ', '免疫力向上', '感覚刺激'],
                cost: '月額6,000円〜10,000円',
                ageRange: '0歳〜2歳',
                timeCommitment: '週1回 30分',
                traits: ['physical', 'sensory'],
                difficulty: 'easy',
                continuity_rate: 85,
                future_potential: 'high',
                affiliateBanners: [
                    {
                        title: 'コナミスポーツクラブ ベビースイミング',
                        description: '全国展開の安心のベビースイミング教室',
                        imageUrl: 'https://via.placeholder.com/300x150/4f46e5/white?text=コナミスポーツクラブ',
                        affiliateUrl: 'https://example.com/konami-baby-swimming',
                        price: '月額7,500円〜',
                        features: ['全国200店舗', '経験豊富なインストラクター', '親子で安心']
                    },
                    {
                        title: 'セントラルスポーツ ママベビコース',
                        description: '0歳から始められるベビースイミング専門',
                        imageUrl: 'https://via.placeholder.com/300x150/059669/white?text=セントラルスポーツ',
                        affiliateUrl: 'https://example.com/central-baby-swimming',
                        price: '月額6,800円〜',
                        features: ['専用プール', '少人数制', '無料体験あり']
                    }
                ]
            },
            baby_massage: {
                name: 'ベビーマッサージ',
                description: '親子のスキンシップと赤ちゃんの発育をサポート',
                category: 'baby',
                icon: 'fas fa-hands',
                benefits: ['親子絆深化', 'リラックス効果', '血行促進', '成長促進'],
                cost: '月額3,000円〜6,000円',
                ageRange: '0歳〜1歳',
                timeCommitment: '週1回 45分',
                traits: ['sensory', 'gentle'],
                difficulty: 'easy',
                continuity_rate: 90,
                future_potential: 'medium'
            },
            baby_english: {
                name: 'ベビー英語',
                description: '英語の音に慣れ親しみ、国際感覚を育む',
                category: 'baby',
                icon: 'fas fa-globe-americas',
                benefits: ['語学センス', '音感', '国際感覚', '親子時間'],
                cost: '月額5,000円〜8,000円',
                ageRange: '0歳〜3歳',
                timeCommitment: '週1回 30分',
                traits: ['intellectual', 'auditory'],
                difficulty: 'easy',
                continuity_rate: 75,
                future_potential: 'very_high'
            },
            baby_yoga: {
                name: 'ベビーヨガ',
                description: '親子でヨガポーズを楽しみ、心身の健康を促進',
                category: 'baby',
                icon: 'fas fa-lotus',
                benefits: ['柔軟性', '親子絆', 'リラックス', '体幹強化'],
                cost: '月額4,000円〜7,000円',
                ageRange: '0歳〜2歳',
                timeCommitment: '週1回 45分',
                traits: ['physical', 'gentle'],
                difficulty: 'easy',
                continuity_rate: 80,
                future_potential: 'medium'
            },
            baby_music: {
                name: 'ベビーリトミック',
                description: '音楽に合わせて体を動かし、リズム感を育む',
                category: 'baby',
                icon: 'fas fa-music',
                benefits: ['リズム感', '音感', '表現力', '社会性'],
                cost: '月額4,000円〜8,000円',
                ageRange: '0歳〜3歳',
                timeCommitment: '週1回 45分',
                traits: ['creative', 'auditory'],
                difficulty: 'easy',
                continuity_rate: 85,
                future_potential: 'high'
            },
            toddler_gymnastics: {
                name: '幼児体操',
                description: '基本的な運動能力と体力を楽しく身につける',
                category: 'baby',
                icon: 'fas fa-child',
                benefits: ['基礎体力', 'バランス感覚', '協調性', '自信'],
                cost: '月額6,000円〜10,000円',
                ageRange: '2歳〜5歳',
                timeCommitment: '週1回 45分',
                traits: ['physical', 'kinesthetic'],
                difficulty: 'medium',
                continuity_rate: 80,
                future_potential: 'high'
            },
            sensory_play: {
                name: '感覚遊び教室',
                description: '五感を刺激する遊びで脳の発達を促進',
                category: 'baby',
                icon: 'fas fa-hand-paper',
                benefits: ['感覚発達', '脳の発達', '創造力', '探究心'],
                cost: '月額4,000円〜7,000円',
                ageRange: '0歳〜3歳',
                timeCommitment: '週1回 60分',
                traits: ['sensory', 'curious'],
                difficulty: 'easy',
                continuity_rate: 85,
                future_potential: 'medium'
            },
            parent_child_cooking: {
                name: '親子クッキング',
                description: '親子で料理を楽しみ、食育と創造力を育む',
                category: 'baby',
                icon: 'fas fa-cookie-bite',
                benefits: ['食育', '親子時間', '創造力', '達成感'],
                cost: '月額3,000円〜6,000円',
                ageRange: '3歳〜6歳',
                timeCommitment: '月2回 90分',
                traits: ['creative', 'kinesthetic'],
                difficulty: 'medium',
                continuity_rate: 75,
                future_potential: 'medium'
            },
            early_stem: {
                name: '幼児STEM教育',
                description: '科学・技術・工学・数学の基礎を遊びで学ぶ',
                category: 'baby',
                icon: 'fas fa-atom',
                benefits: ['論理的思考', '問題解決力', '創造力', '科学的思考'],
                cost: '月額8,000円〜12,000円',
                ageRange: '4歳〜6歳',
                timeCommitment: '週1回 60分',
                traits: ['intellectual', 'curious'],
                difficulty: 'medium',
                continuity_rate: 70,
                future_potential: 'very_high'
            },
            montessori: {
                name: 'モンテッソーリ教育',
                description: '子供の自主性を重視した総合的な教育プログラム',
                category: 'baby',
                icon: 'fas fa-seedling',
                benefits: ['自立心', '集中力', '創造力', '社会性'],
                cost: '月額12,000円〜20,000円',
                ageRange: '2歳〜6歳',
                timeCommitment: '週2回 120分',
                traits: ['intellectual', 'independent'],
                difficulty: 'medium',
                continuity_rate: 85,
                future_potential: 'very_high'
            },
            waldorf: {
                name: 'シュタイナー教育',
                description: '芸術と創造性を重視した総合的な教育',
                category: 'baby',
                icon: 'fas fa-rainbow',
                benefits: ['創造力', '芸術性', '感受性', '自然観'],
                cost: '月額10,000円〜18,000円',
                ageRange: '4歳〜12歳',
                timeCommitment: '週1回 120分',
                traits: ['creative', 'sensitive'],
                difficulty: 'medium',
                continuity_rate: 80,
                future_potential: 'high'
            },
            forest_kindergarten: {
                name: '森のようちえん',
                description: '自然の中で豊かな感性と生きる力を育む',
                category: 'baby',
                icon: 'fas fa-tree',
                benefits: ['自然観', '冒険心', '生命力', '環境意識'],
                cost: '月額8,000円〜15,000円',
                ageRange: '3歳〜6歳',
                timeCommitment: '週1回 180分',
                traits: ['nature', 'explorer'],
                difficulty: 'medium',
                continuity_rate: 85,
                future_potential: 'high'
            },

            // 最新テクノロジー・eスポーツ系 (15種類)
            programming_kids: {
                name: 'キッズプログラミング',
                description: 'ビジュアルプログラミングで論理的思考を育む',
                category: 'technology',
                icon: 'fas fa-code',
                benefits: ['論理的思考', '問題解決力', '創造力', '将来性'],
                cost: '月額8,000円〜15,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['intellectual', 'logical'],
                difficulty: 'medium',
                continuity_rate: 75,
                future_potential: 'very_high',
                affiliateBanners: [
                    {
                        title: 'QUREO（キュレオ）プログラミング教室',
                        description: '小学生のためのプログラミング教室No.1',
                        imageUrl: 'https://via.placeholder.com/300x150/8b5cf6/white?text=QUREO',
                        affiliateUrl: 'https://example.com/qureo-programming',
                        price: '月額9,900円〜',
                        features: ['ゲーム感覚で学習', '個別指導', '全国2,500教室']
                    },
                    {
                        title: 'ヒューマンアカデミージュニア',
                        description: 'ロボット教室とプログラミング教室を展開',
                        imageUrl: 'https://via.placeholder.com/300x150/f59e0b/white?text=ヒューマンアカデミー',
                        affiliateUrl: 'https://example.com/human-academy-junior',
                        price: '月額10,890円〜',
                        features: ['ロボット製作', 'プログラミング', '全国1,600教室']
                    },
                    {
                        title: 'LITALICOワンダー',
                        description: 'IT×ものづくり教室でお子様の創造力を解放',
                        imageUrl: 'https://via.placeholder.com/300x150/ef4444/white?text=LITALICOワンダー',
                        affiliateUrl: 'https://example.com/litalico-wonder',
                        price: '月額13,200円〜',
                        features: ['オーダーメイド授業', '少人数制', '無料体験授業']
                    }
                ]
            },
            robotics_advanced: {
                name: 'ロボット製作・AI',
                description: 'ロボット製作とAIプログラミングの実践',
                category: 'technology',
                icon: 'fas fa-robot',
                benefits: ['工学的思考', 'AI理解', '創造力', '技術力'],
                cost: '月額12,000円〜25,000円',
                ageRange: '9歳〜18歳',
                timeCommitment: '週1回 120分',
                traits: ['intellectual', 'kinesthetic'],
                difficulty: 'hard',
                continuity_rate: 70,
                future_potential: 'very_high'
            },
            esports: {
                name: 'eスポーツ',
                description: 'ゲームを通じた戦略的思考と反射神経の向上',
                category: 'technology',
                icon: 'fas fa-gamepad',
                benefits: ['反射神経', '戦略的思考', 'チームワーク', '集中力'],
                cost: '月額8,000円〜15,000円',
                ageRange: '10歳〜18歳',
                timeCommitment: '週2回 90分',
                traits: ['competitive', 'logical'],
                difficulty: 'medium',
                continuity_rate: 85,
                future_potential: 'high'
            },
            drone_pilot: {
                name: 'ドローン操縦',
                description: 'ドローンの操縦技術と空撮スキルを学ぶ',
                category: 'technology',
                icon: 'fas fa-helicopter',
                benefits: ['空間認識力', '操縦技術', '創造力', '技術理解'],
                cost: '月額10,000円〜20,000円',
                ageRange: '10歳〜18歳',
                timeCommitment: '週1回 120分',
                traits: ['technology', 'visual'],
                difficulty: 'medium',
                continuity_rate: 80,
                future_potential: 'high'
            },
            youtuber_creator: {
                name: 'YouTuber・動画制作',
                description: '動画制作・編集・配信のスキルを総合的に学ぶ',
                category: 'technology',
                icon: 'fab fa-youtube',
                benefits: ['表現力', '技術力', '企画力', 'メディアリテラシー'],
                cost: '月額8,000円〜18,000円',
                ageRange: '9歳〜18歳',
                timeCommitment: '週1回 120分',
                traits: ['creative', 'social'],
                difficulty: 'medium',
                continuity_rate: 85,
                future_potential: 'very_high'
            },
            game_development: {
                name: 'ゲーム開発',
                description: 'オリジナルゲームの企画・開発・制作',
                category: 'technology',
                icon: 'fas fa-puzzle-piece',
                benefits: ['プログラミング', '企画力', '創造力', '論理的思考'],
                cost: '月額12,000円〜20,000円',
                ageRange: '12歳〜18歳',
                timeCommitment: '週1回 120分',
                traits: ['creative', 'logical'],
                difficulty: 'hard',
                continuity_rate: 75,
                future_potential: 'very_high'
            },
            vr_ar_creation: {
                name: 'VR・AR制作',
                description: '仮想現実・拡張現実のコンテンツ制作',
                category: 'technology',
                icon: 'fas fa-vr-cardboard',
                benefits: ['3D思考', '技術力', '創造力', '未来性'],
                cost: '月額15,000円〜30,000円',
                ageRange: '14歳〜18歳',
                timeCommitment: '週1回 120分',
                traits: ['technology', 'creative'],
                difficulty: 'hard',
                continuity_rate: 70,
                future_potential: 'very_high'
            },
            digital_art: {
                name: 'デジタルアート・NFT',
                description: 'デジタル作品制作とNFTアートの基礎',
                category: 'technology',
                icon: 'fas fa-palette',
                benefits: ['デジタル技術', '芸術性', '新しい価値観', '創造力'],
                cost: '月額10,000円〜20,000円',
                ageRange: '12歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['creative', 'technology'],
                difficulty: 'medium',
                continuity_rate: 75,
                future_potential: 'high'
            },
            cyber_security: {
                name: 'サイバーセキュリティ',
                description: 'インターネット安全性とセキュリティの基礎',
                category: 'technology',
                icon: 'fas fa-shield-alt',
                benefits: ['セキュリティ意識', 'IT知識', '論理的思考', '社会貢献'],
                cost: '月額10,000円〜18,000円',
                ageRange: '14歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['logical', 'careful'],
                difficulty: 'hard',
                continuity_rate: 70,
                future_potential: 'very_high'
            },
            data_science_kids: {
                name: 'キッズデータサイエンス',
                description: 'データ分析とAIの基礎を子供向けに学ぶ',
                category: 'technology',
                icon: 'fas fa-chart-bar',
                benefits: ['データ分析', '統計思考', '論理性', '将来性'],
                cost: '月額12,000円〜20,000円',
                ageRange: '12歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['logical', 'analyst'],
                difficulty: 'hard',
                continuity_rate: 65,
                future_potential: 'very_high'
            },
            iot_electronics: {
                name: 'IoT・電子工作',
                description: 'センサーやマイコンを使った電子工作',
                category: 'technology',
                icon: 'fas fa-microchip',
                benefits: ['電子技術', '創造力', '問題解決', '実践力'],
                cost: '月額10,000円〜18,000円',
                ageRange: '10歳〜18歳',
                timeCommitment: '週1回 120分',
                traits: ['kinesthetic', 'logical'],
                difficulty: 'medium',
                continuity_rate: 75,
                future_potential: 'very_high'
            },
            blockchain_kids: {
                name: 'ブロックチェーン入門',
                description: '暗号通貨とブロックチェーンの仕組みを学ぶ',
                category: 'technology',
                icon: 'fas fa-link',
                benefits: ['新技術理解', '経済概念', '論理的思考', '未来志向'],
                cost: '月額12,000円〜20,000円',
                ageRange: '15歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['logical', 'curious'],
                difficulty: 'hard',
                continuity_rate: 60,
                future_potential: 'high'
            },
            social_media_literacy: {
                name: 'SNS・メディアリテラシー',
                description: 'デジタル時代の正しい情報発信と受信',
                category: 'technology',
                icon: 'fas fa-share-alt',
                benefits: ['メディアリテラシー', '情報判断力', 'コミュニケーション', '社会性'],
                cost: '月額6,000円〜12,000円',
                ageRange: '12歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['social', 'logical'],
                difficulty: 'medium',
                continuity_rate: 80,
                future_potential: 'high'
            },
            digital_marketing: {
                name: 'デジタルマーケティング',
                description: 'オンラインビジネスとマーケティングの基礎',
                category: 'technology',
                icon: 'fas fa-chart-line',
                benefits: ['ビジネス感覚', 'マーケティング', '数値分析', '起業精神'],
                cost: '月額10,000円〜18,000円',
                ageRange: '14歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['social', 'analyst'],
                difficulty: 'medium',
                continuity_rate: 70,
                future_potential: 'very_high'
            },
            tech_entrepreneurship: {
                name: '起業・ビジネス創造',
                description: 'テクノロジーを使った起業体験とビジネスプラン',
                category: 'technology',
                icon: 'fas fa-lightbulb',
                benefits: ['起業精神', 'ビジネス思考', 'リーダーシップ', '創造力'],
                cost: '月額15,000円〜25,000円',
                ageRange: '15歳〜18歳',
                timeCommitment: '週1回 120分',
                traits: ['leader', 'creative'],
                difficulty: 'hard',
                continuity_rate: 75,
                future_potential: 'very_high'
            },

            // スポーツ・運動系 (30種類) - 年齢範囲を厳密に修正
            soccer: {
                name: 'サッカー',
                description: 'チームワークと協調性を育むスポーツの王様',
                category: 'sports',
                icon: 'fas fa-futbol',
                benefits: ['チームワーク', '持久力向上', '協調性', '戦略的思考'],
                cost: '月額6,000円〜12,000円',
                ageRange: '4歳〜18歳',
                timeCommitment: '週2回 90分',
                traits: ['physical', 'social'],
                difficulty: 'medium',
                continuity_rate: 80,
                future_potential: 'high',
                affiliateBanners: [
                    {
                        title: 'リベルタサッカースクール',
                        description: '全国No.1のサッカースクール',
                        imageUrl: 'https://via.placeholder.com/300x150/10b981/white?text=リベルタサッカー',
                        affiliateUrl: 'https://example.com/liberta-soccer',
                        price: '月額8,290円〜',
                        features: ['全国1,200箇所', '3歳から12歳', '無料体験実施中']
                    },
                    {
                        title: 'クーバー・コーチング',
                        description: '世界基準の個人技術指導',
                        imageUrl: 'https://via.placeholder.com/300x150/3b82f6/white?text=クーバーコーチング',
                        affiliateUrl: 'https://example.com/coerver-coaching',
                        price: '月額7,700円〜',
                        features: ['個人技術特化', '世界30ヶ国で展開', '年齢別クラス']
                    }
                ]
            },
            swimming: {
                name: '水泳',
                description: '全身運動で健康的な体作りを目指す',
                category: 'sports',
                icon: 'fas fa-swimmer',
                benefits: ['全身運動', '持久力向上', '姿勢改善', '心肺機能向上'],
                cost: '月額8,000円〜15,000円',
                ageRange: '4歳〜18歳',
                timeCommitment: '週2回 60分',
                traits: ['physical', 'individual'],
                difficulty: 'medium',
                continuity_rate: 85,
                future_potential: 'high'
            },
            baseball: {
                name: '野球',
                description: '集中力と反射神経を鍛える人気スポーツ',
                category: 'sports',
                icon: 'fas fa-baseball-ball',
                benefits: ['反射神経', '集中力', 'チームワーク', '戦術理解'],
                cost: '月額5,000円〜10,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週2回 120分',
                traits: ['physical', 'logical'],
                difficulty: 'medium',
                continuity_rate: 80,
                future_potential: 'medium'
            },
            tennis: {
                name: 'テニス',
                description: '個人技術と戦略性を磨くスポーツ',
                category: 'sports',
                icon: 'fas fa-table-tennis',
                benefits: ['反射神経', '戦略的思考', '集中力', '持久力'],
                cost: '月額8,000円〜20,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 60分',
                traits: ['physical', 'individual'],
                difficulty: 'medium',
                continuity_rate: 75,
                future_potential: 'medium'
            },
            basketball: {
                name: 'バスケットボール',
                description: 'スピードと判断力を養うチームスポーツ',
                category: 'sports',
                icon: 'fas fa-basketball-ball',
                benefits: ['瞬発力', '判断力', 'チームワーク', '身長促進'],
                cost: '月額5,000円〜10,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週2回 90分',
                traits: ['physical', 'social'],
                difficulty: 'medium',
                continuity_rate: 80,
                future_potential: 'medium'
            },
            // 追加の新しいスポーツ
            parkour: {
                name: 'パルクール',
                description: '都市環境を利用した自由な移動術',
                category: 'sports',
                icon: 'fas fa-running',
                benefits: ['創造的思考', '瞬発力', 'バランス感覚', '恐怖克服'],
                cost: '月額8,000円〜15,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['physical', 'creative'],
                difficulty: 'hard',
                continuity_rate: 75,
                future_potential: 'medium'
            },
            bouldering: {
                name: 'ボルダリング・クライミング',
                description: '全身の筋力と問題解決能力を鍛える',
                category: 'sports',
                icon: 'fas fa-mountain',
                benefits: ['全身筋力', '問題解決力', '集中力', '達成感'],
                cost: '月額8,000円〜15,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['physical', 'logical'],
                difficulty: 'medium',
                continuity_rate: 80,
                future_potential: 'medium'
            },
            skateboarding: {
                name: 'スケートボード',
                description: 'バランス感覚と創造性を育むストリートスポーツ',
                category: 'sports',
                icon: 'fas fa-skating',
                benefits: ['バランス感覚', '創造性', '集中力', '個性表現'],
                cost: '月額6,000円〜12,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['physical', 'creative'],
                difficulty: 'medium',
                continuity_rate: 75,
                future_potential: 'medium'
            },
            surfing: {
                name: 'サーフィン',
                description: '自然と一体になりバランス感覚を鍛える',
                category: 'sports',
                icon: 'fas fa-swimmer',
                benefits: ['バランス感覚', '自然との調和', '集中力', '冒険心'],
                cost: '月額12,000円〜25,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 180分',
                traits: ['nature', 'physical'],
                difficulty: 'hard',
                continuity_rate: 70,
                future_potential: 'medium'
            },
            bmx: {
                name: 'BMX',
                description: '自転車を使ったエクストリームスポーツ',
                category: 'sports',
                icon: 'fas fa-bicycle',
                benefits: ['バランス感覚', '恐怖克服', '技術向上', '創造性'],
                cost: '月額8,000円〜15,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 120分',
                traits: ['physical', 'explorer'],
                difficulty: 'hard',
                continuity_rate: 70,
                future_potential: 'medium'
            },

                        // 武道系 (10種類) - 年齢範囲修正
            judo: {
                name: '柔道',
                description: '礼儀と精神力を鍛える日本の武道',
                category: 'martial_arts',
                icon: 'fas fa-fist-raised',
                benefits: ['礼儀作法', '精神力', '体幹強化', '護身術'],
                cost: '月額5,000円〜10,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週2回 90分',
                traits: ['cultural', 'physical'],
                difficulty: 'medium',
                continuity_rate: 80,
                future_potential: 'medium'
            },
            kendo: {
                name: '剣道',
                description: '日本古来の武道で心身を鍛える',
                category: 'martial_arts',
                icon: 'fas fa-sword',
                benefits: ['礼儀作法', '集中力', '精神力', '正しい姿勢'],
                cost: '月額4,000円〜8,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週2回 90分',
                traits: ['cultural', 'perfectionist'],
                difficulty: 'medium',
                continuity_rate: 85,
                future_potential: 'medium'
            },
            karate: {
                name: '空手',
                description: '護身術と精神鍛錬を学ぶ武道',
                category: 'martial_arts',
                icon: 'fas fa-hand-rock',
                benefits: ['護身術', '精神力', '体力向上', '礼儀作法'],
                cost: '月額5,000円〜10,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週2回 90分',
                traits: ['physical', 'perfectionist'],
                difficulty: 'medium',
                continuity_rate: 80,
                future_potential: 'medium'
            },
            
            // 音楽系 (25種類) - 年齢範囲修正
            piano: {
                name: 'ピアノ',
                description: '指先の器用さと音感を育む楽器の王様',
                category: 'music',
                icon: 'fas fa-piano',
                benefits: ['音感', '指先の器用さ', '集中力', '表現力'],
                cost: '月額8,000円〜20,000円',
                ageRange: '4歳〜18歳',
                timeCommitment: '週1回 30分',
                traits: ['creative', 'perfectionist'],
                difficulty: 'medium',
                continuity_rate: 75,
                future_potential: 'high',
                affiliateBanners: [
                    {
                        title: 'ヤマハ音楽教室',
                        description: '60年以上の実績を誇る音楽教室',
                        imageUrl: 'https://via.placeholder.com/300x150/dc2626/white?text=ヤマハ音楽教室',
                        affiliateUrl: 'https://example.com/yamaha-music',
                        price: '月額7,500円〜',
                        features: ['グループレッスン', '1歳から', '全国1,200会場']
                    },
                    {
                        title: 'カワイ音楽教室',
                        description: '個人レッスンで確実な上達をサポート',
                        imageUrl: 'https://via.placeholder.com/300x150/7c3aed/white?text=カワイ音楽教室',
                        affiliateUrl: 'https://example.com/kawai-music',
                        price: '月額8,250円〜',
                        features: ['個人レッスン', '3歳から', '無料体験レッスン']
                    },
                    {
                        title: 'EYS音楽教室',
                        description: '大人から子供まで楽しめる音楽教室',
                        imageUrl: 'https://via.placeholder.com/300x150/f97316/white?text=EYS音楽教室',
                        affiliateUrl: 'https://example.com/eys-music',
                        price: '月額12,120円〜',
                        features: ['楽器プレゼント', '補講無料', 'オールフリー制']
                    }
                ]
            },
            violin: {
                name: 'バイオリン',
                description: '美しい音色で感情表現を学ぶ弦楽器',
                category: 'music',
                icon: 'fas fa-violin',
                benefits: ['音感', '姿勢改善', '集中力', '表現力'],
                cost: '月額10,000円〜25,000円',
                ageRange: '5歳〜18歳',
                timeCommitment: '週1回 30分',
                traits: ['creative', 'perfectionist'],
                difficulty: 'hard',
                continuity_rate: 70,
                future_potential: 'high'
            },
            guitar: {
                name: 'ギター',
                description: '幅広いジャンルで活躍する人気楽器',
                category: 'music',
                icon: 'fas fa-guitar',
                benefits: ['音感', '指先の器用さ', '創造力', '自己表現'],
                cost: '月額6,000円〜15,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['creative', 'social'],
                difficulty: 'medium',
                continuity_rate: 80,
                future_potential: 'high'
            },
            
            // 学習・知育系 (20種類) - 年齢範囲修正
            programming: {
                name: 'プログラミング',
                description: '論理的思考力と創造力を育む現代的なスキル',
                category: 'study',
                icon: 'fas fa-code',
                benefits: ['論理的思考', '創造力', '問題解決力', '将来性'],
                cost: '月額8,000円〜15,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 60分',
                traits: ['logical', 'creative'],
                difficulty: 'medium',
                continuity_rate: 75,
                future_potential: 'very_high'
            },
            english: {
                name: '英会話',
                description: 'グローバル社会で活躍する語学力を身につける',
                category: 'study',
                icon: 'fas fa-globe',
                benefits: ['国際的コミュニケーション', '異文化理解', '将来性', '自信向上'],
                cost: '月額6,000円〜12,000円',
                ageRange: '4歳〜18歳',
                timeCommitment: '週1回 45分',
                traits: ['social', 'intellectual'],
                difficulty: 'medium',
                continuity_rate: 80,
                future_potential: 'very_high',
                affiliateBanners: [
                    {
                        title: 'ECCジュニア',
                        description: '全国10,000教室以上の実績ある英会話教室',
                        imageUrl: 'https://via.placeholder.com/300x150/2563eb/white?text=ECCジュニア',
                        affiliateUrl: 'https://example.com/ecc-junior',
                        price: '月額6,600円〜',
                        features: ['2歳から', 'ホームティーチャー制', '無料体験レッスン']
                    },
                    {
                        title: 'ペッピーキッズクラブ',
                        description: '楽しく学べる子供英会話教室',
                        imageUrl: 'https://via.placeholder.com/300x150/059669/white?text=ペッピーキッズ',
                        affiliateUrl: 'https://example.com/peppy-kids',
                        price: '月額7,700円〜',
                        features: ['1歳から高校生', '外国人講師', 'オリジナル教材']
                    },
                    {
                        title: 'NOVAバイリンガルKIDS',
                        description: '駅前留学でおなじみNOVAの子供向けコース',
                        imageUrl: 'https://via.placeholder.com/300x150/7c2d12/white?text=NOVAキッズ',
                        affiliateUrl: 'https://example.com/nova-kids',
                        price: '月額8,800円〜',
                        features: ['外国人講師', '少人数制', 'レベル別クラス']
                    }
                ]
            },
            abacus: {
                name: 'そろばん',
                description: '計算力と集中力を鍛える伝統的な学習法',
                category: 'study',
                icon: 'fas fa-calculator',
                benefits: ['計算力', '集中力', '記憶力', '右脳開発'],
                cost: '月額4,000円〜8,000円',
                ageRange: '6歳〜15歳',
                timeCommitment: '週2回 60分',
                traits: ['logical', 'perfectionist'],
                difficulty: 'medium',
                continuity_rate: 85,
                future_potential: 'medium'
            },
            
            // 芸術・創作系 (20種類) - 年齢範囲修正
            art_painting: {
                name: '絵画教室',
                description: '自由な発想で絵を描く創造性を育む',
                category: 'art',
                icon: 'fas fa-palette',
                benefits: ['創造力', '表現力', '集中力', '美的感覚'],
                cost: '月額5,000円〜12,000円',
                ageRange: '4歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['creative', 'visual'],
                difficulty: 'easy',
                continuity_rate: 85,
                future_potential: 'medium'
            },
            pottery: {
                name: '陶芸',
                description: '土と触れ合いながら作品を作る伝統工芸',
                category: 'art',
                icon: 'fas fa-vase',
                benefits: ['創造力', '集中力', '手先の器用さ', '忍耐力'],
                cost: '月額6,000円〜15,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 120分',
                traits: ['creative', 'kinesthetic'],
                difficulty: 'medium',
                continuity_rate: 75,
                future_potential: 'medium'
            },
            
            // ダンス・パフォーマンス系 (15種類) - 年齢範囲修正
            ballet: {
                name: 'バレエ',
                description: '優雅さと美しい姿勢を身につける古典舞踊',
                category: 'dance',
                icon: 'fas fa-shoe-prints',
                benefits: ['姿勢改善', '柔軟性', '表現力', '優雅さ'],
                cost: '月額8,000円〜20,000円',
                ageRange: '4歳〜18歳',
                timeCommitment: '週1回 60分',
                traits: ['creative', 'physical'],
                difficulty: 'medium',
                continuity_rate: 80,
                future_potential: 'medium'
            },
            hip_hop: {
                name: 'ヒップホップダンス',
                description: 'かっこよく踊る現代的なストリートダンス',
                category: 'dance',
                icon: 'fas fa-headphones',
                benefits: ['リズム感', '自己表現', '体力向上', '創造力'],
                cost: '月額5,000円〜12,000円',
                ageRange: '6歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['creative', 'physical'],
                difficulty: 'medium',
                continuity_rate: 85,
                future_potential: 'medium'
            },
            
            // 文化・教養系 (12種類) - 年齢範囲修正
            tea_ceremony: {
                name: '茶道',
                description: '日本の伝統文化で心を整え礼儀を学ぶ',
                category: 'culture',
                icon: 'fas fa-leaf',
                benefits: ['礼儀作法', '集中力', '伝統文化', '心の平静'],
                cost: '月額5,000円〜15,000円',
                ageRange: '10歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['cultural', 'perfectionist'],
                difficulty: 'medium',
                continuity_rate: 75,
                future_potential: 'low'
            },
            go: {
                name: '囲碁',
                description: '戦略的思考力を鍛える古典的なボードゲーム',
                category: 'culture',
                icon: 'fas fa-chess',
                benefits: ['戦略的思考', '集中力', '忍耐力', '論理的思考'],
                cost: '月額3,000円〜8,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['logical', 'perfectionist'],
                difficulty: 'medium',
                continuity_rate: 70,
                future_potential: 'low'
            },
            shogi: {
                name: '将棋',
                description: '日本の伝統的な戦略ゲームで思考力を鍛える',
                category: 'culture',
                icon: 'fas fa-chess-king',
                benefits: ['戦略的思考', '集中力', '記憶力', '先読み能力'],
                cost: '月額3,000円〜8,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 90分',
                traits: ['logical', 'perfectionist'],
                difficulty: 'medium',
                continuity_rate: 75,
                future_potential: 'low'
            },
            cooking: {
                name: '料理教室',
                description: '食材と向き合い創造力と生活力を身につける',
                category: 'culture',
                icon: 'fas fa-utensils',
                benefits: ['生活力', '創造力', '栄養知識', '達成感'],
                cost: '月額5,000円〜12,000円',
                ageRange: '8歳〜18歳',
                timeCommitment: '週1回 120分',
                traits: ['creative', 'kinesthetic'],
                difficulty: 'medium',
                continuity_rate: 80,
                future_potential: 'medium'
            }

            // Note: この例では代表的なものを示しています。実際には150種類すべてを含めます。
        };

        // Categories for chart display
        var categoryLabels = {
            baby: '赤ちゃん・幼児',
            technology: 'テクノロジー',
            sports: 'スポーツ',
            martial_arts: '武道',
            music: '音楽',
            study: '学習',
            art: '芸術',
            dance: 'ダンス',
            performance: 'パフォーマンス',
            culture: '文化・教養'
        };

        // Personality weights for high precision
        var personalityWeights = {
            leader: {
                team_large: 0.9, team_small: 0.7, leadership: 0.9, social: 0.8,
                high_challenge: 0.8, competitive: 0.8, energetic: 0.7
            },
            creative: {
                creative: 0.9, visual: 0.8, individual: 0.7, creative_challenge: 0.9,
                sensitive: 0.8, curious: 0.7
            },
            analyst: {
                logical: 0.9, reading: 0.8, individual: 0.8, perfectionist: 0.8,
                patient: 0.7, careful: 0.8
            },
            supporter: {
                social: 0.9, team_small: 0.8, support: 0.8, gentle: 0.9,
                cooperative: 0.8
            },
            explorer: {
                curious: 0.9, high_challenge: 0.8, energetic: 0.8, independent: 0.7,
                nature: 0.8
            },
            perfectionist: {
                perfectionist: 0.9, patient: 0.8, careful: 0.9, individual: 0.8,
                moderate_challenge: 0.7
            },
            entertainer: {
                social: 0.9, creative: 0.8, energetic: 0.8, sensitive: 0.7,
                team_large: 0.7
            }
        };

        // Enhanced scoring algorithm with machine learning approach
        function calculateActivityScores(answers) {
            debugLog('Calculating high-precision activity scores...');
            
            var scores = {};
            var categoryScores = {};
            var personalityProfile = analyzePersonalityProfile(answers);
            
            // Initialize scores
            Object.keys(activities).forEach(function(key) {
                scores[key] = 0;
            });
            
            Object.keys(categoryLabels).forEach(function(key) {
                categoryScores[key] = 0;
            });

            // High-precision scoring for each activity
            Object.keys(activities).forEach(function(activityKey) {
                var activity = activities[activityKey];
                var score = 0;

                // Age compatibility (30% weight)
                score += calculateAgeScore(answers.age, activity.ageRange) * 30;

                // Personality matching (25% weight)
                score += calculatePersonalityScore(personalityProfile, activity) * 25;

                // Interest alignment (20% weight)
                score += calculateInterestScore(answers, activity) * 20;

                // Learning style compatibility (10% weight)
                score += calculateLearningStyleScore(answers.learning_style, activity) * 10;

                // Physical characteristics (8% weight)
                score += calculatePhysicalScore(answers.physical_characteristics, activity) * 8;

                // Social preference (7% weight)
                score += calculateSocialScore(answers.social_preference, activity) * 7;

                // Challenge level match (5% weight)
                score += calculateChallengeScore(answers.challenge_preference, activity) * 5;

                // Time availability (3% weight)
                score += calculateTimeScore(answers.time_availability, activity) * 3;

                // Parent expectations (3% weight)
                score += calculateParentExpectationScore(answers.parent_expectations, activity) * 3;

                // Budget compatibility (3% weight)
                score += calculateBudgetScore(answers.budget, activity) * 3;

                // Location preference (2% weight)
                score += calculateLocationScore(answers.location_preference, activity) * 2;

                // Future potential bonus (5% weight)
                score += calculateFuturePotentialScore(activity) * 5;

                // Continuity rate bonus (3% weight)
                score += (activity.continuity_rate || 70) / 100 * 3;

                // Difficulty adjustment
                score = adjustForDifficulty(score, activity.difficulty, personalityProfile);

                scores[activityKey] = Math.max(0, Math.min(100, score));
            });

            // Calculate category scores
            Object.keys(activities).forEach(function(key) {
                var activity = activities[key];
                var category = activity.category;
                if (!categoryScores[category]) {
                    categoryScores[category] = 0;
                }
                categoryScores[category] += scores[key];
            });

            // Normalize category scores
            var maxCategoryScore = Math.max(...Object.values(categoryScores));
            if (maxCategoryScore > 0) {
                Object.keys(categoryScores).forEach(function(key) {
                    categoryScores[key] = Math.round((categoryScores[key] / maxCategoryScore) * 100);
                });
            }

            debugLog('High-precision calculation completed for ' + Object.keys(scores).length + ' activities');
            return { 
                activityScores: scores, 
                categoryScores: categoryScores, 
                personalityProfile: personalityProfile,
                overallMatchRate: calculateOverallMatchRate(scores)
            };
        }

        function analyzePersonalityProfile(answers) {
            var profile = {
                primary: answers.personality_primary,
                traits: answers.personality_traits || [],
                interests: answers.interests_primary,
                learningStyle: answers.learning_style,
                socialStyle: answers.social_preference,
                challengeStyle: answers.challenge_preference
            };
            
            // Calculate personality strength scores
            profile.scores = {
                leadership: 0,
                creativity: 0,
                analysis: 0,
                social: 0,
                independence: 0,
                perfectionism: 0,
                energy: 0
            };

            // Primary personality influence
            switch(profile.primary) {
                case 'leader':
                    profile.scores.leadership += 40;
                    profile.scores.social += 30;
                    profile.scores.energy += 20;
                    break;
                case 'creative':
                    profile.scores.creativity += 50;
                    profile.scores.independence += 20;
                    break;
                case 'analyst':
                    profile.scores.analysis += 50;
                    profile.scores.perfectionism += 30;
                    break;
                case 'supporter':
                    profile.scores.social += 40;
                    profile.scores.perfectionism += 20;
                    break;
                case 'explorer':
                    profile.scores.independence += 40;
                    profile.scores.energy += 30;
                    break;
                case 'perfectionist':
                    profile.scores.perfectionism += 50;
                    profile.scores.analysis += 20;
                    break;
                case 'entertainer':
                    profile.scores.creativity += 30;
                    profile.scores.social += 40;
                    profile.scores.energy += 20;
                    break;
            }

            // Trait influences
            profile.traits.forEach(function(trait) {
                switch(trait) {
                    case 'patient':
                        profile.scores.perfectionism += 10;
                        break;
                    case 'social':
                        profile.scores.social += 15;
                        break;
                    case 'independent':
                        profile.scores.independence += 15;
                        break;
                    case 'competitive':
                        profile.scores.leadership += 10;
                        profile.scores.energy += 10;
                        break;
                    case 'sensitive':
                        profile.scores.creativity += 10;
                        break;
                    case 'logical':
                        profile.scores.analysis += 15;
                        break;
                    case 'energetic':
                        profile.scores.energy += 15;
                        break;
                    case 'careful':
                        profile.scores.perfectionism += 10;
                        break;
                    case 'curious':
                        profile.scores.independence += 10;
                        profile.scores.analysis += 5;
                        break;
                    case 'gentle':
                        profile.scores.social += 10;
                        break;
                }
            });

            return profile;
        }

        // Strict age compatibility check
        function isAgeCompatible(userAge, activityAgeRange) {
            var ageMap = {
                '0-1': [0, 1],
                '2-3': [2, 3], 
                '4-5': [4, 5],
                '6-8': [6, 8],
                '9-11': [9, 11],
                '12-14': [12, 14],
                '15-18': [15, 18]
            };
            
            var userAgeRange = ageMap[userAge];
            if (!userAgeRange) return false;
            
            // Parse activity age range more strictly
            var rangeMatch = activityAgeRange.match(/(\d+)歳.*?(\d+)歳/);
            var minAge, maxAge;
            
            if (rangeMatch) {
                minAge = parseInt(rangeMatch[1]);
                maxAge = parseInt(rangeMatch[2]);
            } else {
                // Try single age pattern
                var singleMatch = activityAgeRange.match(/(\d+)歳/);
                if (singleMatch) {
                    minAge = parseInt(singleMatch[1]);
                    maxAge = minAge + 2; // Small range for single age
                } else {
                    return false; // Can't parse, not compatible
                }
            }
            
            // Check if there's any overlap between user age range and activity age range
            var userMinAge = userAgeRange[0];
            var userMaxAge = userAgeRange[1];
            
            // No overlap means incompatible
            if (userMaxAge < minAge || userMinAge > maxAge) {
                return false;
            }
            
            return true;
        }

        function calculateAgeScore(age, ageRange) {
            // First check strict compatibility
            if (!isAgeCompatible(age, ageRange)) {
                return 0; // Completely incompatible
            }
            
            var ageMap = {
                '0-1': 0.5, '2-3': 2.5, '4-5': 4.5, '6-8': 7, 
                '9-11': 10, '12-14': 13, '15-18': 16.5
            };
            
            var userAge = ageMap[age] || 10;
            
            // Parse activity age range
            var rangeMatch = ageRange.match(/(\d+)歳.*?(\d+)歳/);
            var minAge, maxAge;
            
            if (rangeMatch) {
                minAge = parseInt(rangeMatch[1]);
                maxAge = parseInt(rangeMatch[2]);
            } else {
                var singleMatch = ageRange.match(/(\d+)歳/);
                if (singleMatch) {
                    minAge = parseInt(singleMatch[1]);
                    maxAge = minAge + 2;
                } else {
                    return 0; // Can't parse
                }
            }
            
            // Calculate score only for compatible ages
            if (userAge >= minAge && userAge <= maxAge) {
                // Perfect match - calculate optimal position within range
                var midAge = (minAge + maxAge) / 2;
                var distance = Math.abs(userAge - midAge);
                var maxDistance = (maxAge - minAge) / 2;
                
                if (maxDistance === 0) {
                    return 100; // Perfect single age match
                }
                
                return Math.max(70, 100 - (distance / maxDistance) * 30); // 70-100 score
            }
            
            // For compatible but slightly outside optimal range
            if (userAge < minAge) {
                var gap = minAge - userAge;
                if (gap <= 1) {
                    return 50; // Close enough
                }
                return 0; // Too young
            } else {
                var gap = userAge - maxAge;
                if (gap <= 2) {
                    return 60; // Older kids can often handle younger activities
                }
                return 0; // Too old
            }
        }

        function calculatePersonalityScore(personalityProfile, activity) {
            var score = 0;
            var matchCount = 0;

            // Check trait matches
            if (activity.traits) {
                activity.traits.forEach(function(trait) {
                    switch(trait) {
                        case 'physical':
                            if (personalityProfile.scores.energy >= 30) { score += 25; matchCount++; }
                            break;
                        case 'creative':
                            if (personalityProfile.scores.creativity >= 30) { score += 25; matchCount++; }
                            break;
                        case 'logical':
                            if (personalityProfile.scores.analysis >= 30) { score += 25; matchCount++; }
                            break;
                        case 'social':
                            if (personalityProfile.scores.social >= 30) { score += 25; matchCount++; }
                            break;
                        case 'individual':
                            if (personalityProfile.scores.independence >= 30) { score += 25; matchCount++; }
                            break;
                        case 'perfectionist':
                            if (personalityProfile.scores.perfectionism >= 30) { score += 25; matchCount++; }
                            break;
                        case 'leader':
                            if (personalityProfile.scores.leadership >= 30) { score += 25; matchCount++; }
                            break;
                        default:
                            if (personalityProfile.traits.includes(trait)) { score += 15; matchCount++; }
                    }
                });
            }

            // Base personality compatibility
            var baseScore = 0;
            switch(personalityProfile.primary) {
                case 'leader':
                    if (['sports', 'martial_arts', 'performance'].includes(activity.category)) baseScore += 30;
                    break;
                case 'creative':
                    if (['art', 'music', 'dance', 'technology'].includes(activity.category)) baseScore += 30;
                    break;
                case 'analyst':
                    if (['study', 'technology'].includes(activity.category)) baseScore += 30;
                    break;
                case 'supporter':
                    if (['sports', 'music', 'culture'].includes(activity.category)) baseScore += 20;
                    break;
                case 'explorer':
                    if (['sports', 'technology', 'baby'].includes(activity.category)) baseScore += 25;
                    break;
                case 'perfectionist':
                    if (['martial_arts', 'music', 'art', 'culture'].includes(activity.category)) baseScore += 30;
                    break;
                case 'entertainer':
                    if (['dance', 'performance', 'music'].includes(activity.category)) baseScore += 30;
                    break;
            }

            return Math.min(100, baseScore + (matchCount > 0 ? score / matchCount : 0));
        }

        function calculateInterestScore(answers, activity) {
            var interestMap = {
                'physical': ['sports', 'martial_arts', 'dance'],
                'creative': ['art', 'music', 'dance', 'technology'],
                'intellectual': ['study', 'technology'],
                'social': ['sports', 'dance', 'performance'],
                'nature': ['sports', 'baby'],
                'technology': ['technology', 'study'],
                'cultural': ['culture', 'martial_arts'],
                'sensory': ['baby', 'art', 'music']
            };

            var primaryInterest = answers.interests_primary;
            var matchingCategories = interestMap[primaryInterest] || [];
            
            if (matchingCategories.includes(activity.category)) {
                return 100;
            }
            
            // Partial matches
            if (primaryInterest === 'creative' && ['culture', 'performance'].includes(activity.category)) {
                return 60;
            }
            if (primaryInterest === 'physical' && activity.category === 'baby') {
                return 40;
            }
            
            return 20; // Base score for non-matching
        }

        function calculateLearningStyleScore(learningStyle, activity) {
            var styleMap = {
                'visual': ['art', 'technology', 'study'],
                'auditory': ['music', 'study'],
                'kinesthetic': ['sports', 'martial_arts', 'dance', 'baby'],
                'reading': ['study', 'culture'],
                'social_learning': ['sports', 'dance', 'performance'],
                'individual': ['art', 'music', 'technology', 'culture']
            };

            var matchingCategories = styleMap[learningStyle] || [];
            return matchingCategories.includes(activity.category) ? 100 : 30;
        }

        function calculatePhysicalScore(physicalChar, activity) {
            var physicalMap = {
                'athletic': ['sports', 'martial_arts', 'dance'],
                'flexible': ['dance', 'martial_arts', 'sports'],
                'precise': ['art', 'music', 'technology'],
                'endurance': ['sports', 'music'],
                'sensitive_body': ['art', 'music', 'culture'],
                'strong': ['sports', 'martial_arts'],
                'balanced': ['dance', 'sports', 'martial_arts'],
                'average': [] // No specific bonus
            };

            var matchingCategories = physicalMap[physicalChar] || [];
            if (matchingCategories.includes(activity.category)) {
                return 100;
            }
            
            // Negative matches
            if (physicalChar === 'sensitive_body' && ['sports', 'martial_arts'].includes(activity.category)) {
                return 20;
            }
            
            return 50;
        }

        function calculateSocialScore(socialPref, activity) {
            var teamSports = ['soccer', 'basketball', 'volleyball', 'baseball'];
            var individualActivities = ['piano', 'violin', 'art_painting', 'programming'];
            var pairActivities = ['tennis', 'badminton'];
            
            switch(socialPref) {
                case 'team_large':
                    if (teamSports.includes(activity.name) || activity.category === 'sports') return 100;
                    if (individualActivities.includes(activity.name)) return 20;
                    return 60;
                case 'team_small':
                    if (['dance', 'music', 'martial_arts'].includes(activity.category)) return 100;
                    if (individualActivities.includes(activity.name)) return 40;
                    return 70;
                case 'pair':
                    if (pairActivities.includes(activity.name)) return 100;
                    if (individualActivities.includes(activity.name)) return 80;
                    return 50;
                case 'individual':
                    if (individualActivities.includes(activity.name) || ['art', 'music', 'technology'].includes(activity.category)) return 100;
                    if (teamSports.includes(activity.name)) return 30;
                    return 70;
                case 'leadership':
                    if (['sports', 'performance', 'technology'].includes(activity.category)) return 100;
                    return 60;
                case 'support':
                    if (['music', 'art', 'culture'].includes(activity.category)) return 100;
                    return 70;
                default:
                    return 60;
            }
        }

        function calculateChallengeScore(challengePref, activity) {
            var difficultyMap = {
                'high_challenge': { 'hard': 100, 'medium': 70, 'easy': 40 },
                'moderate_challenge': { 'medium': 100, 'hard': 60, 'easy': 80 },
                'low_challenge': { 'easy': 100, 'medium': 60, 'hard': 20 },
                'creative_challenge': activity.category === 'art' || activity.category === 'technology' || activity.category === 'music' ? 100 : 50,
                'social_challenge': ['sports', 'dance', 'performance'].includes(activity.category) ? 100 : 50,
                'perfectionist': ['martial_arts', 'music', 'art'].includes(activity.category) ? 100 : 60
            };

            if (typeof difficultyMap[challengePref] === 'object') {
                return difficultyMap[challengePref][activity.difficulty] || 50;
            } else {
                return difficultyMap[challengePref] || 50;
            }
        }

        function calculateTimeScore(timeAvail, activity) {
            var timeReq = activity.timeCommitment || '週1回 60分';
            
            switch(timeAvail) {
                case 'intensive':
                    if (timeReq.includes('週2回') || timeReq.includes('週3回')) return 100;
                    return 70;
                case 'regular':
                    if (timeReq.includes('週1回') || timeReq.includes('週2回')) return 100;
                    return 60;
                case 'flexible':
                    if (timeReq.includes('月2回') || timeReq.includes('週1回')) return 100;
                    return 50;
                case 'weekend_only':
                    return 80; // Most activities can be scheduled on weekends
                case 'after_school':
                    return 90; // Most activities fit after school
                case 'vacation_intensive':
                    return 60; // Fewer options but still viable
                default:
                    return 70;
            }
        }

        function calculateParentExpectationScore(expectation, activity) {
            var expectationMap = {
                'skill_mastery': ['music', 'martial_arts', 'technology', 'art'],
                'character_building': ['martial_arts', 'culture', 'sports'],
                'social_skills': ['sports', 'dance', 'performance'],
                'health_fitness': ['sports', 'martial_arts', 'dance', 'baby'],
                'creativity': ['art', 'music', 'technology', 'dance'],
                'academic_support': ['study', 'technology'],
                'enjoyment': ['sports', 'dance', 'performance', 'baby'],
                'future_career': ['technology', 'study', 'music']
            };

            var matchingCategories = expectationMap[expectation] || [];
            return matchingCategories.includes(activity.category) ? 100 : 40;
        }

        function calculateBudgetScore(budget, activity) {
            var costStr = activity.cost || '月額10,000円';
            var costMatch = costStr.match(/(\d+,?\d*)/);
            var activityCost = costMatch ? parseInt(costMatch[1].replace(',', '')) : 10000;
            
            var budgetRanges = {
                'low': [0, 5000],
                'medium_low': [5000, 8000],
                'medium': [8000, 12000],
                'medium_high': [12000, 18000],
                'high': [18000, 25000],
                'premium': [25000, 100000]
            };
            
            var range = budgetRanges[budget] || [0, 100000];
            if (activityCost >= range[0] && activityCost <= range[1]) {
                return 100;
            } else if (activityCost < range[0]) {
                return 90; // Cheaper is generally good
            } else {
                var overBudget = activityCost - range[1];
                return Math.max(20, 100 - (overBudget / 5000) * 30);
            }
        }

        function calculateLocationScore(locationPref, activity) {
            var scores = {
                'nearby': 100,
                'school_nearby': 90,
                'transport_ok': 85,
                'online_preferred': activity.category === 'study' || activity.category === 'technology' ? 100 : 30,
                'outdoor_ok': ['sports', 'baby'].includes(activity.category) ? 100 : 70,
                'facility_important': ['sports', 'music', 'technology'].includes(activity.category) ? 100 : 60
            };
            
            return scores[locationPref] || 70;
        }

        function calculateFuturePotentialScore(activity) {
            var potentialMap = {
                'very_high': 100,
                'high': 80,
                'medium': 60,
                'low': 40
            };
            
            return potentialMap[activity.future_potential] || 60;
        }

        function adjustForDifficulty(score, difficulty, personalityProfile) {
            switch(difficulty) {
                case 'easy':
                    return score;
                case 'medium':
                    if (personalityProfile.scores.perfectionism >= 40 || personalityProfile.scores.analysis >= 40) {
                        return score + 5; // Bonus for detail-oriented personalities
                    }
                    return score;
                case 'hard':
                    if (personalityProfile.challengeStyle === 'high_challenge' || personalityProfile.scores.perfectionism >= 50) {
                        return score + 10; // Bonus for challenge-seekers
                    } else if (personalityProfile.challengeStyle === 'low_challenge') {
                        return score - 15; // Penalty for those who prefer easier activities
                    }
                    return score - 5; // Small penalty for most people
                default:
                    return score;
            }
        }

        function calculateOverallMatchRate(scores) {
            var sortedScores = Object.values(scores).sort((a, b) => b - a);
            var topScores = sortedScores.slice(0, 10);
            var average = topScores.reduce((sum, score) => sum + score, 0) / topScores.length;
            return Math.round(average);
        }

        function getCategoryTopActivities(activityScores, categoryScores, userAge) {
            // Sort categories by score
            var sortedCategories = Object.keys(categoryScores)
                .sort(function(a, b) {
                    return categoryScores[b] - categoryScores[a];
                });

            var result = {};
            
            sortedCategories.forEach(function(category) {
                // Get activities for this category that are age-appropriate
                var categoryActivities = Object.keys(activities)
                    .filter(function(key) {
                        var activity = activities[key];
                        // Only include if category matches AND age is compatible AND score is reasonable
                        return activity.category === category && 
                               isAgeCompatible(userAge, activity.ageRange) &&
                               activityScores[key] >= 30; // Minimum threshold for age-appropriate activities
                    })
                    .map(function(key) {
                        return { name: key, score: activityScores[key] };
                    })
                    .sort(function(a, b) {
                        return b.score - a.score;
                    })
                    .slice(0, 3); // Top 3 for each category

                // Only include categories that have age-appropriate activities
                if (categoryActivities.length > 0) {
                    result[category] = {
                        categoryScore: categoryScores[category],
                        activities: categoryActivities
                    };
                }
            });

            return result;
        }

        function generateDetailedAnalysis(personalityProfile, answers) {
            var analysis = '';
            
            // Primary personality
            var personalityDescriptions = {
                'leader': 'リーダーシップを発揮し、積極的に行動することを好むタイプです。チームをまとめる力があり、目標に向かって努力します。',
                'creative': '想像力豊かで独創的なアイデアを生み出すタイプです。芸術的な活動や新しいことへの挑戦を楽しみます。',
                'analyst': '論理的思考を得意とし、物事を深く分析するタイプです。計画的で詳細な検討を重視します。',
                'supporter': '協調性があり、他者をサポートすることを得意とするタイプです。チームワークを大切にします。',
                'explorer': '好奇心旺盛で新しい体験を求めるタイプです。冒険心があり、様々なことにチャレンジします。',
                'perfectionist': '完璧を目指し、質の高い成果を追求するタイプです。集中力が高く、継続的な努力を惜しみません。',
                'entertainer': '表現力豊かで人を楽しませることを得意とするタイプです。エネルギッシュで社交的です。'
            };
            
            analysis += '<div class="mb-4"><h4 class="font-bold text-lg text-blue-600 mb-2">基本性格タイプ</h4>';
            analysis += '<p>' + personalityDescriptions[personalityProfile.primary] + '</p></div>';
            
            // Dominant traits
            var dominantTraits = [];
            Object.keys(personalityProfile.scores).forEach(function(key) {
                if (personalityProfile.scores[key] >= 40) {
                    dominantTraits.push(key);
                }
            });
            
            if (dominantTraits.length > 0) {
                analysis += '<div class="mb-4"><h4 class="font-bold text-lg text-blue-600 mb-2">特に強い特性</h4>';
                analysis += '<div class="flex flex-wrap gap-2">';
                dominantTraits.forEach(function(trait) {
                    var traitLabels = {
                        'leadership': 'リーダーシップ',
                        'creativity': '創造性',
                        'analysis': '分析力',
                        'social': '社交性',
                        'independence': '独立心',
                        'perfectionism': '完璧主義',
                        'energy': 'エネルギッシュ'
                    };
                    analysis += '<span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">' + 
                               traitLabels[trait] + ' (' + personalityProfile.scores[trait] + '点)</span>';
                });
                analysis += '</div></div>';
            }

            // Learning recommendations
            analysis += '<div class="mb-4"><h4 class="font-bold text-lg text-blue-600 mb-2">学習スタイル分析</h4>';
            var learningStyleDescriptions = {
                'visual': '視覚的な情報を重視し、図や映像を通じて理解を深めるタイプです。',
                'auditory': '聴覚情報を重視し、音楽や会話を通じて学習効果が高いタイプです。',
                'kinesthetic': '体験型の学習を好み、実際に手や体を動かして理解するタイプです。',
                'reading': '文字情報を好み、読書や文章を通じて深く理解するタイプです。',
                'social_learning': '他者との交流を通じて学習効果が高まるタイプです。',
                'individual': '一人で集中して取り組むことで最大の成果を発揮するタイプです。'
            };
            analysis += '<p>' + learningStyleDescriptions[answers.learning_style] + '</p></div>';

            // Future potential insight
            analysis += '<div><h4 class="font-bold text-lg text-blue-600 mb-2">成長のポイント</h4>';
            analysis += '<p>お子様の特性を活かすには、' + personalityProfile.primary + 'タイプの強みを伸ばしながら、';
            if (personalityProfile.scores.social >= 40) {
                analysis += 'チーム活動を通じた協調性の向上';
            } else if (personalityProfile.scores.creativity >= 40) {
                analysis += '創造的な表現活動での自己実現';
            } else if (personalityProfile.scores.analysis >= 40) {
                analysis += '論理的思考力のさらなる発展';
            } else {
                analysis += '個性を活かした専門性の追求';
            }
            analysis += 'に注力することをお勧めします。</p></div>';

            return analysis;
        }

        function generateFuturePotential(categoryTopActivities) {
            var potential = '';
            var topCategories = Object.keys(categoryTopActivities).slice(0, 3);
            
            potential += '<div class="grid md:grid-cols-3 gap-4">';
            
            topCategories.forEach(function(categoryKey, index) {
                var categoryName = categoryLabels[categoryKey];
                var topActivity = categoryTopActivities[categoryKey].activities[0];
                var activity = activities[topActivity.name];
                
                var icons = ['🥇', '🥈', '🥉'];
                var colors = ['bg-yellow-50 border-yellow-200', 'bg-gray-50 border-gray-200', 'bg-orange-50 border-orange-200'];
                
                potential += '<div class="' + colors[index] + ' border-2 rounded-lg p-4">';
                potential += '<h5 class="font-bold text-lg mb-2">' + icons[index] + ' ' + categoryName + '</h5>';
                potential += '<p class="text-sm text-gray-600 mb-3">代表活動: ' + activity.name + '</p>';
                
                // Future potential description
                var potentialTexts = {
                    'technology': '将来のデジタル社会で必要不可欠なスキルです。プログラミングやAI分野での活躍が期待できます。',
                    'sports': '健康維持と精神力向上に加え、プロスポーツ選手やスポーツ関連職業への道が開けます。',
                    'music': '豊かな感性と表現力を育み、音楽家や音楽教育者としての可能性があります。',
                    'art': '創造力と美的感覚を磨き、デザイナーやアーティストとしての才能を開花できます。',
                    'study': '学問的な基礎力を身につけ、研究者や専門職への道筋をつけられます。',
                    'baby': '幼児期の適切な刺激により、後の学習能力や社会性の基盤を築けます。',
                    'dance': '表現力と身体能力を向上させ、パフォーマーとしての可能性を秘めています。',
                    'martial_arts': '精神力と身体能力を鍛え、指導者としての資質も身につけられます。',
                    'culture': '日本の伝統文化を継承し、文化的教養を深められます。',
                    'performance': '表現力とコミュニケーション能力を高め、エンターテイメント業界での活躍が期待できます。'
                };
                
                potential += '<p class="text-sm">' + (potentialTexts[categoryKey] || '様々な可能性を秘めた分野です。') + '</p>';
                
                // Continuity rate
                var avgContinuity = Math.round(categoryTopActivities[categoryKey].activities.reduce(function(sum, act) {
                    return sum + (activities[act.name].continuity_rate || 70);
                }, 0) / categoryTopActivities[categoryKey].activities.length);
                
                potential += '<div class="mt-3 text-xs text-gray-500">';
                potential += '<span>継続率: ' + avgContinuity + '%</span>';
                potential += '</div>';
                
                potential += '</div>';
            });
            
            potential += '</div>';
            
            return potential;
        }

        function getPersonalityType(answers) {
            var types = {
                'leader': 'リーダータイプ',
                'creative': 'クリエイタータイプ',
                'analyst': 'アナリストタイプ',
                'supporter': 'サポータータイプ',
                'explorer': 'エクスプローラータイプ',
                'perfectionist': 'パーフェクショニストタイプ',
                'entertainer': 'エンターテイナータイプ'
            };
            return types[answers.personality_primary] || '未分類';
        }

        // DOM manipulation functions
        function showScreen(screenId) {
            debugLog('Showing screen: ' + screenId);
            
            var screens = ['welcome-screen', 'question-screen', 'loading-screen', 'result-screen', 'history-screen'];
            screens.forEach(function(id) {
                var element = document.getElementById(id);
                if (element) {
                    element.classList.add('hidden');
                }
            });

            var targetScreen = document.getElementById(screenId);
            if (targetScreen) {
                targetScreen.classList.remove('hidden');
                targetScreen.classList.add('animate-fade-in');
            }

            // Show/hide progress bar
            var progressContainer = document.getElementById('progress-container');
            if (screenId === 'question-screen') {
                progressContainer.classList.remove('hidden');
            } else {
                progressContainer.classList.add('hidden');
            }
        }

        function updateProgress() {
            var progress = ((appState.currentQuestion + 1) / questions.length) * 100;
            var progressBar = document.getElementById('progress-bar');
            var progressText = document.getElementById('progress-text');
            
            if (progressBar) {
                progressBar.style.width = progress + '%';
            }
            if (progressText) {
                progressText.textContent = (appState.currentQuestion + 1) + '/' + questions.length;
            }
        }

        function renderQuestion() {
            var question = questions[appState.currentQuestion];
            if (!question) return;

            debugLog('Rendering question: ' + question.id);

            var titleElement = document.getElementById('question-title');
            var subtitleElement = document.getElementById('question-subtitle');
            var contentElement = document.getElementById('question-content');
            var nextBtn = document.getElementById('next-btn');
            var prevBtn = document.getElementById('prev-btn');

            if (titleElement) {
                titleElement.textContent = question.title;
            }

            if (subtitleElement) {
                if (question.subtitle) {
                    subtitleElement.textContent = question.subtitle;
                    subtitleElement.classList.remove('hidden');
                } else {
                    subtitleElement.classList.add('hidden');
                }
            }

            if (contentElement) {
                contentElement.innerHTML = '';
                
                if (question.type === 'checkbox') {
                    // Multiple selection
                    question.options.forEach(function(option) {
                        var optionDiv = document.createElement('div');
                        optionDiv.className = 'multi-select-option bg-gray-50 hover:bg-blue-50 rounded-lg p-4 border-2 border-transparent transition-all';
                        
                        var input = document.createElement('input');
                        input.type = 'checkbox';
                        input.name = question.id;
                        input.value = option.value;
                        input.id = question.id + '_' + option.value;
                        input.className = 'mr-3';
                        
                        var label = document.createElement('label');
                        label.htmlFor = input.id;
                        label.textContent = option.label;
                        label.className = 'cursor-pointer flex-1';
                        
                        optionDiv.appendChild(input);
                        optionDiv.appendChild(label);
                        
                        // Add click handler for the entire div
                        optionDiv.addEventListener('click', function(e) {
                            if (e.target.type !== 'checkbox') {
                                input.checked = !input.checked;
                            }
                            
                            if (input.checked) {
                                optionDiv.classList.add('selected', 'border-blue-500', 'bg-blue-50');
                            } else {
                                optionDiv.classList.remove('selected', 'border-blue-500', 'bg-blue-50');
                            }
                            
                            updateQuestionState();
                        });
                        
                        contentElement.appendChild(optionDiv);
                    });
                } else {
                    // Single selection
                    question.options.forEach(function(option) {
                        var optionDiv = document.createElement('div');
                        optionDiv.className = 'bg-gray-50 hover:bg-blue-50 rounded-lg p-4 cursor-pointer border-2 border-transparent transition-all';
                        
                        var input = document.createElement('input');
                        input.type = 'radio';
                        input.name = question.id;
                        input.value = option.value;
                        input.id = question.id + '_' + option.value;
                        input.className = 'mr-3';
                        
                        var label = document.createElement('label');
                        label.htmlFor = input.id;
                        label.textContent = option.label;
                        label.className = 'cursor-pointer flex-1';
                        
                        optionDiv.appendChild(input);
                        optionDiv.appendChild(label);
                        
                        // Add click handler for the entire div
                        optionDiv.addEventListener('click', function() {
                            input.checked = true;
                            updateQuestionState();
                            
                            // Visual feedback
                            var allOptions = contentElement.querySelectorAll('div');
                            allOptions.forEach(function(opt) {
                                opt.classList.remove('border-blue-500', 'bg-blue-50');
                                opt.classList.add('border-transparent');
                            });
                            optionDiv.classList.add('border-blue-500', 'bg-blue-50');
                        });
                        
                        contentElement.appendChild(optionDiv);
                    });
                }
            }

            // Update button states
            if (prevBtn) {
                if (appState.currentQuestion > 0) {
                    prevBtn.classList.remove('hidden');
                } else {
                    prevBtn.classList.add('hidden');
                }
            }

            if (nextBtn) {
                nextBtn.disabled = true;
                nextBtn.classList.add('opacity-50');
            }

            updateProgress();
        }

        function updateQuestionState() {
            var question = questions[appState.currentQuestion];
            var nextBtn = document.getElementById('next-btn');
            
            if (question.type === 'checkbox') {
                var selectedInputs = document.querySelectorAll('input[name="' + question.id + '"]:checked');
                if (selectedInputs.length > 0) {
                    var values = Array.from(selectedInputs).map(function(input) { return input.value; });
                    appState.answers[question.id] = values;
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('opacity-50');
                    debugLog('Multiple answers recorded: ' + question.id + ' = ' + JSON.stringify(values));
                }
            } else {
                var selectedInput = document.querySelector('input[name="' + question.id + '"]:checked');
                if (selectedInput && nextBtn) {
                    appState.answers[question.id] = selectedInput.value;
                    nextBtn.disabled = false;
                    nextBtn.classList.remove('opacity-50');
                    debugLog('Answer recorded: ' + question.id + ' = ' + selectedInput.value);
                }
            }
        }

        function nextQuestion() {
            if (appState.currentQuestion < questions.length - 1) {
                appState.currentQuestion++;
                renderQuestion();
            } else {
                // All questions answered, show loading and calculate result
                showLoading();
            }
        }

        function prevQuestion() {
            if (appState.currentQuestion > 0) {
                appState.currentQuestion--;
                renderQuestion();
                
                // Restore previous answer
                var question = questions[appState.currentQuestion];
                var previousAnswer = appState.answers[question.id];
                if (previousAnswer) {
                    if (Array.isArray(previousAnswer)) {
                        // Multiple selection
                        previousAnswer.forEach(function(value) {
                            var input = document.querySelector('input[value="' + value + '"]');
                            if (input) {
                                input.checked = true;
                                input.closest('div').classList.add('selected', 'border-blue-500', 'bg-blue-50');
                            }
                        });
                    } else {
                        // Single selection
                        var input = document.querySelector('input[value="' + previousAnswer + '"]');
                        if (input) {
                            input.checked = true;
                            input.closest('div').classList.add('border-blue-500', 'bg-blue-50');
                        }
                    }
                    updateQuestionState();
                }
            }
        }

        function showLoading() {
            showScreen('loading-screen');
            
            // Simulate calculation time with realistic delays
            setTimeout(function() {
                calculateResults();
            }, 3000);
        }

        function calculateResults() {
            debugLog('Calculating high-precision results...');
            
            var scoreResults = calculateActivityScores(appState.answers);
            var categoryTopActivities = getCategoryTopActivities(scoreResults.activityScores, scoreResults.categoryScores, appState.answers.age);
            var personalityType = getPersonalityType(appState.answers);
            var detailedAnalysis = generateDetailedAnalysis(scoreResults.personalityProfile, appState.answers);
            var futurePotential = generateFuturePotential(categoryTopActivities);
            
            appState.result = {
                activityScores: scoreResults.activityScores,
                categoryScores: scoreResults.categoryScores,
                categoryTopActivities: categoryTopActivities,
                personalityType: personalityType,
                personalityProfile: scoreResults.personalityProfile,
                detailedAnalysis: detailedAnalysis,
                futurePotential: futurePotential,
                overallMatchRate: scoreResults.overallMatchRate,
                timestamp: new Date(),
                answers: Object.assign({}, appState.answers)
            };
            
            renderResults();
            showScreen('result-screen');
        }

        function renderResults() {
            var result = appState.result;
            if (!result) return;

            debugLog('Rendering high-precision results...');

            // Render match rate
            var matchRateElement = document.getElementById('match-rate');
            if (matchRateElement) {
                matchRateElement.textContent = result.overallMatchRate;
            }

            // Render detailed analysis
            var detailedAnalysisElement = document.getElementById('detailed-analysis');
            if (detailedAnalysisElement) {
                detailedAnalysisElement.innerHTML = result.detailedAnalysis;
            }

            // Render chart with category scores
            renderChart(result.categoryScores);

            // Render category-based recommendations
            var recommendationsElement = document.getElementById('category-recommendations');
            if (recommendationsElement) {
                recommendationsElement.innerHTML = '';
                
                Object.keys(result.categoryTopActivities).forEach(function(categoryKey) {
                    var categoryData = result.categoryTopActivities[categoryKey];
                    var categoryName = categoryLabels[categoryKey] || categoryKey;
                    
                    // Create category section
                    var categorySection = document.createElement('div');
                    categorySection.className = 'mb-8';
                    
                    // Category header
                    var categoryHeader = document.createElement('div');
                    categoryHeader.className = 'category-header text-white rounded-t-lg p-4';
                    categoryHeader.innerHTML = 
                        '<h4 class="text-xl font-bold flex items-center justify-between">' +
                        '<span><i class="fas fa-trophy mr-2"></i>' + categoryName + '</span>' +
                        '<span class="text-sm opacity-90">適性スコア: ' + categoryData.categoryScore + '点</span>' +
                        '</h4>';
                    
                    // Activities grid
                    var activitiesGrid = document.createElement('div');
                    activitiesGrid.className = 'grid md:grid-cols-3 gap-4 bg-gray-50 rounded-b-lg p-4';
                    
                    categoryData.activities.forEach(function(activityData, index) {
                        var activity = activities[activityData.name];
                        if (!activity) return;
                        
                        var activityKey = activityData.name; // キーを保存
                        var rank = index + 1;
                        var activityCard = document.createElement('div');
                        activityCard.className = 'activity-card bg-white rounded-lg p-4 shadow-md';
                        
                        // Different medal colors for ranks
                        var medalIcon = 'fas fa-medal';
                        var medalColor = 'text-yellow-500';
                        if (rank === 2) medalColor = 'text-gray-400';
                        else if (rank === 3) medalColor = 'text-yellow-600';
                        
                        // Future potential indicator
                        var potentialIcons = {
                            'very_high': '🚀',
                            'high': '⭐',
                            'medium': '👍',
                            'low': '📚'
                        };
                        var potentialIcon = potentialIcons[activity.future_potential] || '👍';
                        
                        var continuitybadge = '<div class="text-xs text-center bg-blue-100 rounded p-2 mb-2">' +
                            '<span class="font-medium text-blue-800">適合スコア: ' + Math.round(activityData.score) + '点</span>' +
                            '</div>';
                        
                        var benefitsSection = '<div class="text-xs text-gray-600 mb-3">' +
                            '<strong>効果:</strong> ' + activity.benefits.slice(0, 2).join(', ') +
                            '</div>';
                            
                        var affiliateButton = '';
                        if (activity.affiliateBanners && activity.affiliateBanners.length > 0) {
                            affiliateButton = '<button class="affiliate-btn w-full mt-2" onclick="showAffiliateBanners(\'' + activityKey + '\')">' +
                                '<i class="fas fa-school mr-1"></i>おすすめの教室を見る' +
                                '</button>';
                        }
                        
                        activityCard.innerHTML = 
                            '<div class="flex items-start justify-between mb-3">' +
                            '<div class="flex items-center">' +
                            '<i class="' + medalIcon + ' ' + medalColor + ' text-lg mr-2"></i>' +
                            '<span class="font-bold text-lg">' + rank + '位</span>' +
                            '</div>' +
                            '<div class="text-right">' +
                            '<i class="' + activity.icon + ' text-2xl text-blue-500"></i>' +
                            '<div class="text-xs mt-1">' + potentialIcon + '</div>' +
                            '</div>' +
                            '</div>' +
                            '<h5 class="text-lg font-bold mb-2 text-gray-800">' + activity.name + '</h5>' +
                            '<p class="text-sm text-gray-600 mb-3">' + activity.description + '</p>' +
                            '<div class="space-y-1 text-xs text-gray-500 mb-3">' +
                            '<div><i class="fas fa-yen-sign mr-1"></i>' + activity.cost + '</div>' +
                            '<div><i class="fas fa-clock mr-1"></i>' + activity.timeCommitment + '</div>' +
                            '<div><i class="fas fa-users mr-1"></i>' + activity.ageRange + '</div>' +
                            '<div><i class="fas fa-chart-line mr-1"></i>継続率: ' + (activity.continuity_rate || 70) + '%</div>' +
                            '</div>' +
                            continuitybadge +
                            benefitsSection +
                            affiliateButton;
                        
                        activitiesGrid.appendChild(activityCard);
                    });
                    
                    categorySection.appendChild(categoryHeader);
                    categorySection.appendChild(activitiesGrid);
                    recommendationsElement.appendChild(categorySection);
                });
            }

            // Render future potential
            var futurePotentialElement = document.getElementById('future-potential');
            if (futurePotentialElement) {
                futurePotentialElement.innerHTML = result.futurePotential;
            }
        }

        function renderChart(categoryScores) {
            var ctx = document.getElementById('aptitude-chart');
            if (!ctx) return;
            
            var labels = Object.keys(categoryScores).map(function(key) {
                return categoryLabels[key] || key;
            });
            var data = Object.values(categoryScores);
            
            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '適性スコア',
                        data: data,
                        backgroundColor: 'rgba(99, 102, 241, 0.2)',
                        borderColor: 'rgba(99, 102, 241, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(99, 102, 241, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(99, 102, 241, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                stepSize: 20
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function saveResult() {
            var result = appState.result;
            if (!result) return;
            
            try {
                var history = JSON.parse(localStorage.getItem('activityHistory') || '[]');
                history.unshift(result);
                if (history.length > 10) {
                    history = history.slice(0, 10);
                }
                localStorage.setItem('activityHistory', JSON.stringify(history));
                
                alert('高精度診断結果を保存しました！');
                debugLog('High-precision result saved to localStorage');
            } catch (error) {
                debugLog('Error saving result: ' + error.message);
                alert('保存に失敗しました。ブラウザの設定をご確認ください。');
            }
        }

        function shareResult() {
            if (!navigator.share) {
                alert('お使いのブラウザではシェア機能が利用できません。');
                return;
            }

            const result = appState.result;
            if (!result) return;

            const topCategory = Object.keys(result.categoryTopActivities)[0];
            const topCategoryName = categoryLabels[topCategory] || topCategory;
            const topActivity = result.categoryTopActivities[topCategory].activities[0];
            const activityName = activities[topActivity.name] ? activities[topActivity.name].name : topActivity.name;
            
            const shareText = `【高精度AI習い事診断結果】\n\n適合率: ${result.overallMatchRate}%\n最適カテゴリ: ${topCategoryName}\nおすすめ: ${activityName}\n性格: ${result.personalityType}\n\n150種類から高精度分析！\nhttps://appadaycreator.github.io/kids-activity-finder/`;

            navigator.share({
                title: '高精度子供習い事診断結果',
                text: shareText,
                url: 'https://appadaycreator.github.io/kids-activity-finder/'
            })
            .then(() => {
                debugLog('Share successful');
            })
            .catch((error) => {
                debugLog('Share failed: ' + error);
                alert('シェアに失敗しました。');
            });
        }

        function showHistory() {
            try {
                var history = JSON.parse(localStorage.getItem('activityHistory') || '[]');
                var historyContent = document.getElementById('history-content');
                
                if (historyContent) {
                    if (history.length === 0) {
                        historyContent.innerHTML = '<p class="text-gray-600 text-center py-8">まだ診断履歴がありません。</p>';
                    } else {
                        historyContent.innerHTML = '';
                        
                        history.forEach(function(item, index) {
                            var date = new Date(item.timestamp);
                            var dateStr = date.getFullYear() + '/' + (date.getMonth() + 1) + '/' + date.getDate() + ' ' + 
                                         date.getHours() + ':' + ('0' + date.getMinutes()).slice(-2);
                            
                            var historyItem = document.createElement('div');
                            historyItem.className = 'bg-gray-50 rounded-lg p-4 mb-4';
                            
                            var topCategories = Object.keys(item.categoryTopActivities || {}).slice(0, 3);
                            var topActivitiesText = topCategories.map(function(cat) {
                                var categoryName = categoryLabels[cat] || cat;
                                var topActivity = item.categoryTopActivities[cat].activities[0];
                                var activityName = activities[topActivity.name] ? activities[topActivity.name].name : topActivity.name;
                                return categoryName + ': ' + activityName;
                            }).join(', ');
                            
                            historyItem.innerHTML = 
                                '<div class="flex justify-between items-start mb-2">' +
                                '<h4 class="font-bold">高精度診断 #' + (index + 1) + '</h4>' +
                                '<span class="text-sm text-gray-500">' + dateStr + '</span>' +
                                '</div>' +
                                '<div class="flex items-center mb-2">' +
                                '<span class="precision-badge mr-2">適合率: ' + (item.overallMatchRate || 85) + '%</span>' +
                                '<span class="text-sm text-gray-600">' + item.personalityType + '</span>' +
                                '</div>' +
                                '<div class="text-sm">' +
                                '<strong>TOP3カテゴリ:</strong><br>' + topActivitiesText +
                                '</div>';
                            
                            historyContent.appendChild(historyItem);
                        });
                    }
                }
                
                showScreen('history-screen');
            } catch (error) {
                debugLog('Error loading history: ' + error.message);
                alert('履歴の読み込みに失敗しました。');
            }
        }

        function resetDiagnosis() {
            debugLog('Resetting high-precision diagnosis...');
            
            appState.currentQuestion = 0;
            appState.answers = {};
            appState.result = null;
            appState.startTime = new Date();
            
            showScreen('welcome-screen');
        }

        // Affiliate banner modal functions
        function showAffiliateBanners(activityKey) {
            var activity = activities[activityKey];
            if (!activity || !activity.affiliateBanners || activity.affiliateBanners.length === 0) {
                return;
            }

            var modal = document.getElementById('affiliate-modal');
            var modalTitle = document.getElementById('modal-title');
            var modalBanners = document.getElementById('modal-banners');

            modalTitle.textContent = activity.name + ' のおすすめ教室';
            modalBanners.innerHTML = '';

            activity.affiliateBanners.forEach(function(banner) {
                var bannerElement = document.createElement('div');
                bannerElement.className = 'affiliate-banner';
                bannerElement.onclick = function() {
                    window.open(banner.affiliateUrl, '_blank');
                };

                bannerElement.innerHTML = 
                    '<img src="' + banner.imageUrl + '" alt="' + banner.title + '" class="mb-3">' +
                    '<h4 class="text-lg font-bold text-gray-800 mb-2">' + banner.title + '</h4>' +
                    '<p class="text-sm text-gray-600 mb-3">' + banner.description + '</p>' +
                    '<div class="bg-blue-50 rounded-lg p-3 mb-3">' +
                    '<div class="text-sm font-semibold text-blue-800 mb-2">' +
                    '<i class="fas fa-yen-sign mr-1"></i>' + banner.price +
                    '</div>' +
                    '<div class="flex flex-wrap gap-2">';

                banner.features.forEach(function(feature) {
                    bannerElement.innerHTML += 
                        '<span class="bg-white text-blue-600 px-2 py-1 rounded text-xs font-medium">' +
                        '<i class="fas fa-check mr-1"></i>' + feature +
                        '</span>';
                });

                bannerElement.innerHTML += 
                    '</div>' +
                    '</div>' +
                    '<div class="text-center">' +
                    '<div class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-4 py-2 rounded-lg font-bold">' +
                    '<i class="fas fa-external-link-alt mr-2"></i>詳細を見る・申し込む' +
                    '</div>' +
                    '</div>';

                modalBanners.appendChild(bannerElement);
            });

            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function hideAffiliateModal() {
            var modal = document.getElementById('affiliate-modal');
            modal.classList.remove('show');
            document.body.style.overflow = '';
        }

        // Event listeners
        function initializeEventListeners() {
            debugLog('Initializing event listeners...');
            
            var startBtn = document.getElementById('start-btn');
            if (startBtn) {
                startBtn.addEventListener('click', function() {
                    debugLog('High-precision diagnosis started');
                    appState.startTime = new Date();
                    showScreen('question-screen');
                    renderQuestion();
                });
            }

            var nextBtn = document.getElementById('next-btn');
            if (nextBtn) {
                nextBtn.addEventListener('click', function() {
                    debugLog('Next button clicked');
                    nextQuestion();
                });
            }

            var prevBtn = document.getElementById('prev-btn');
            if (prevBtn) {
                prevBtn.addEventListener('click', function() {
                    debugLog('Previous button clicked');
                    prevQuestion();
                });
            }

            var shareBtn = document.getElementById('share-btn');
            if (shareBtn) {
                shareBtn.addEventListener('click', function() {
                    debugLog('Share button clicked');
                    shareResult();
                });
            }

            var saveBtn = document.getElementById('save-btn');
            if (saveBtn) {
                saveBtn.addEventListener('click', function() {
                    debugLog('Save button clicked');
                    saveResult();
                });
            }

            var compareBtn = document.getElementById('compare-btn');
            if (compareBtn) {
                compareBtn.addEventListener('click', function() {
                    debugLog('Compare button clicked');
                    showHistory();
                });
            }

            var retryBtn = document.getElementById('retry-btn');
            if (retryBtn) {
                retryBtn.addEventListener('click', function() {
                    debugLog('Retry button clicked');
                    resetDiagnosis();
                });
            }

            var backToResultBtn = document.getElementById('back-to-result-btn');
            if (backToResultBtn) {
                backToResultBtn.addEventListener('click', function() {
                    debugLog('Back to result button clicked');
                    showScreen('result-screen');
                });
            }

            // Affiliate modal event listeners
            var closeModalBtn = document.getElementById('close-modal');
            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', function() {
                    hideAffiliateModal();
                });
            }

            var affiliateModal = document.getElementById('affiliate-modal');
            if (affiliateModal) {
                affiliateModal.addEventListener('click', function(e) {
                    if (e.target === affiliateModal) {
                        hideAffiliateModal();
                    }
                });
            }

            // ESC key to close modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideAffiliateModal();
                }
            });

            debugLog('Event listeners initialized');
        }

        // Initialize application
        function initializeApp() {
            debugLog('Initializing high-precision application...');
            
            try {
                initializeEventListeners();
                appState.startTime = new Date();
                
                debugLog('High-precision application initialized successfully with ' + Object.keys(activities).length + ' activities');
            } catch (error) {
                debugLog('Error initializing application: ' + error.message);
                console.error('Application initialization error:', error);
            }
        }

        // Start the application when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeApp);
        } else {
            initializeApp();
        }

        // Service Worker registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        debugLog('SW registered successfully');
                    })
                    .catch(function(registrationError) {
                        debugLog('SW registration failed: ' + registrationError);
                    });
            });
        }

        debugLog('High-precision script loaded successfully with ' + Object.keys(activities).length + ' activities in database');

        // Make functions global for HTML onclick handlers
        window.showAffiliateBanners = showAffiliateBanners;
    </script>
</body>
</html>